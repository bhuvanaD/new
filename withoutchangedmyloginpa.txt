angular.module('DoinSport.controllers', [
	'ngCordovaOauth',
	'ionic-datepicker',
	'ionic-timepicker',
	'ionic-ratings',
])






//=== Land Controller ===//
.controller("Land", function($rootScope, $window, $state, $scope, $q, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $location, LoaderService, apiUrl){


	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");

	
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);

		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};



	$scope.success = function(res){
		if(res.status){
			$rootScope.currentUser = res.data;
			$scope.inputDate = new Date($scope.currentUser.birthdate);
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$scope.currentUser.sport_id = String($scope.currentUser.sport_id);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.data.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.data.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			$scope.authuser = $scope.currentUser;


			if($scope.authuser.sport_id != null && $scope.authuser.sport_id != 'null' && $scope.authuser.sport_id != ''){ $state.go("app.matchs", {}, { reload: true, }); }
			else{ $state.go("app.home", {}, { reload: true, }); }
			$scope.sports = res.sports;


			$rootScope.$broadcast("updateAuthUser", $scope.currentUser, $scope.sports);
			if(!$scope.$$phase){ $scope.$apply(); }

		}

		else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};


	$scope.leaveLanding = function(){
		if($scope.email && $scope.apiToken){
			var user = JSON.parse($window.localStorage.getItem("user"));
			$http.get(apiUrl + "/api/v1?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error(function(err){
				$state.go("app.home", {}, { reload: true, }); 
			});
			/*if(user && user.sport_id){ $state.go("app.matchs", {}, { reload: true, }); }
			else{ $state.go("app.home", {}, { reload: true, }); }*/
		}

		else{ $state.go("showAuth", {}, { reload: true, }); };
	};


	$scope.view = 2;
	$scope.tennisSplash = function(){
		$scope.view = 5;
		$timeout(function(){ $scope.leaveLanding(); }, 700);
	};


	$scope.padelSplash = function(){
		$scope.view = 4;
		$timeout(function(){ $scope.tennisSplash(); }, 700);
	};


	$scope.squashSplash = function(){
		$scope.view = 3;
		$timeout(function(){ $scope.padelSplash(); }, 700);
	};

	$timeout(function(){ $scope.squashSplash(); }, 1000);
})





//=== Show Auth Controller ===//
.controller("ShowAuth", function($rootScope, $window, $state, $scope, $q, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $location, LoaderService, apiUrl){
	$scope.$state = $state;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	$scope.gotoprofile = function(){ $state.go("app.profile", {}, { reload: true, }); };
	$scope.Register = function(){ $state.go("register", {}, { reload: true, }); };
	$scope.Login = function(){ $state.go("login", {}, { reload: true, }); };
})





//=== Register Controller ===//
.controller("Register", function($rootScope, $window, $state, $scope, $cordovaGoogleAnalytics, $q, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, $cordovaKeyboard, apiUrl, ionicDatePicker, facebookApi, googleApi, $cordovaDevice, $cordovaGeolocation, LoaderService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
// gotohome funtion declarted in login page

	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };


	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	$scope.gotoprofile = function(){ $state.go("app.profile", {}, { reload: true, }); };


	if(window.cordova){ $scope.deviceId = $cordovaDevice.getUUID(); }
	else{ $scope.deviceId = moment().format("YYYYMMDDTHHmmssS"); }
	$scope.signupData = { deviceId: $scope.deviceId, };


	if(window.analytics){ $cordovaGoogleAnalytics.trackView('SignUp'); };
	$scope.genders = [{ key: "male", value: "Homme", }, { key: "female", value: "Femme", }];


	$scope.getOption = function(option){ return option.key; };


	$scope.success = function(res){
		if(res.status){
			res.data.api_token = res.api_token;
			$rootScope.currentUser = res.data;
			$window.localStorage.setItem('login_email', $scope.signupData.email);
			$window.localStorage.setItem('login_password', $scope.signupData.password);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;


			if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('SignUp', 'User SignUp', "Email", $rootScope.currentUser.email); };
			$state.go("app.home", {}, { reload: true, });
		}

		else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};


	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		LoaderService.Hide();
		$ionicPopup.alert({ title: error, });
	};

	$scope.Register = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/register", data).success($scope.success).error($scope.error);
			}catch(err){
				LoaderService.Hide();
				$ionicPopup.alert({ title: err.error, template: err, });
			}
		};
	};


	$scope.SocialRegister = function(userData){
		LoaderService.Show();

		$http.defaults.headers.post["Content-Type"] = "application/json";

		$http.post(apiUrl + "/api/v1/auth/social", userData).success(function(res){

			LoaderService.Hide();
			if(res.status){
				res.data.api_token = res.api_token;
				$rootScope.currentUser = res.data;
				$window.localStorage.setItem('email', res.data.email);
				$window.localStorage.setItem('api_token', res.api_token);
				$window.localStorage.setItem('user', JSON.stringify(res.data));
				$window.sessionStorage.currentEmail = res.data.email; // Access Token details
				$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
				$window.sessionStorage.user_id = res.data.id;
				if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('SignUp', 'User SignUp', "Email", $rootScope.currentUser.email); };
				$state.go("app.home", {}, { reload: true, });
			}else{ $ionicPopup.alert({ title: res.error, }); };
		}).error($scope.error);
	};


	$scope.SocialError = function(error){
		LoaderService.Hide();
		$ionicPopup.alert({ title: error, });
	};


	$scope.FBLogin = function(){
		$cordovaOauth.facebook(facebookApi, ["public_profile", "email"]).then(function(result){
			LoaderService.Show();
			$http.get("https://graph.facebook.com/v2.2/me", { params: { access_token: result.access_token, fields: "name,email,gender,location,picture", format: "json" } }).then(function(data){
				var profileInfo = data.data, userData = {
					email: profileInfo.email,
					password: profileInfo.id,
					age: 1, name: profileInfo.name,
					gender: profileInfo.gender ? profileInfo.gender : 'male',
					socialId: profileInfo.id, social: 1,
					deviceId: $scope.deviceId,
				};

				$scope.SocialRegister(userData);
			},
			 $scope.SocialError);
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};

	$scope.GoogleLogin = function(){
		$cordovaOauth.google(googleApi, ["https://www.googleapis.com/auth/userinfo.profile", "https://www.googleapis.com/auth/userinfo.email"]).then(function(result){
			try{
				LoaderService.Show();
				$http({ url: 'https://www.googleapis.com/oauth2/v3/userinfo', method: 'GET', params: { access_token: result.access_token, }, }).then(function(data){
					var profileInfo = data.data, userData = {
						email: profileInfo.email,
						password: profileInfo.sub,
						age: 1, name: profileInfo.name,
						gender: profileInfo.gender ? profileInfo.gender : 'male',
						socialId: profileInfo.sub, social: 0,
						deviceId: $scope.deviceId,
					};
					$scope.SocialRegister(userData);
				}, $scope.SocialError);
			}catch(err){
				LoaderService.Hide();
				$ionicPopup.alert({ title: err.error, template: err, });
			}
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};




	$scope.inputDate = new Date();
	$scope.openDatePicker = function(){
		ionicDatePicker.openDatePicker({
			callback: function(val){
				$scope.inputDate = new Date(val);
				$scope.signupData.birthdate = moment(val).format("DD/MM/YYYY");
			},
			from: moment().subtract("110", "years"),
			to: new Date(),
			inputDate: $scope.inputDate,
			mondayFirst: false,
			closeOnSelect: true,
			dateFormat: 'dd/MM/yyyy',
			templateType: 'popup',
			titleLabel: 'Sélectionnez une date',
			setLabel: 'Définir',
			todayLabel: 'Aujourd\'hui',
			closeLabel: 'Fermer',
			weeksList: [ "D","L","M","M","J","V","S" ],
			monthsList: [ "janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc." ],
		});
	};
})









//=== Login Controller ===//
/*.controller("Login", function($rootScope, $window, $state, $scope, $cordovaGoogleAnalytics, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi, $cordovaDevice)
{
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");

	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };

	if($scope.email && $scope.apiToken)

		{
		 $scope.gotohome();
		  };

	var strEmail = $window.localStorage.getItem('login_email');

	$scope.loginData = (strEmail != null && strEmail != 'null') ? { email: strEmail, password: $window.localStorage.getItem('login_password'), } : {};

	if(window.cordova){
	 $scope.deviceId = $cordovaDevice.getUUID(); 
	}

	else{
	 $scope.deviceId = moment().format("YYYYMMDDTHHmmssS");
	  }

	if(window.analytics){
	 $cordovaGoogleAnalytics.trackView('Login'); 
	};

	$scope.success = function(res){
		if(res.status){

			res.data.api_token = res.api_token;
			$rootScope.currentUser = res.data;
			$window.localStorage.setItem('login_email', $scope.loginData.email);
			$window.localStorage.setItem('login_password', $scope.loginData.password);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;

			if(window.analytics){
			 $cordovaGoogleAnalytics.trackEvent('Login', 'User Login', "Email", $rootScope.currentUser.email); 
		};


			$state.go("app.home", {}, { reload: true, });
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};


	$scope.error = function(err){

		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};


	$scope.Login = function(form, data){

		if(form.$valid){
			$scope.loginData.email = data.email;
			$scope.loginData.password = data.password;
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";

				$http.post(apiUrl + "/api/v1/auth/login", {
					email: $scope.loginData.email,
					password: $scope.loginData.password,
					deviceId: $scope.deviceId,
				}).success($scope.success).error($scope.error);
			}

			catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};


	$scope.SocialLogin = function(userData){
		LoaderService.Show();

		$http.defaults.headers.post["Content-Type"] = "application/json";

		$http.post(apiUrl + "/api/v1/auth/social", userData).success(function(res){

			LoaderService.Hide();

			if(res.status){
				res.data.api_token = res.api_token;
				$rootScope.currentUser = res.data;	
				$window.localStorage.setItem('email', res.data.email);
				$window.localStorage.setItem('api_token', res.api_token);
				$window.localStorage.setItem('user', JSON.stringify(res.data));
				$window.sessionStorage.currentEmail = res.data.email; // Access Token details
				$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
				$window.sessionStorage.user_id = res.data.id;

				if(window.analytics){

				 $cordovaGoogleAnalytics.trackEvent('Login', 'User Login', "Email", $rootScope.currentUser.email);

				  };

				$state.go("app.home", {}, { reload: true, });
			}

			else{ $ionicPopup.alert({ title: res.error, }); };
		}).error($scope.error);
	};



	$scope.SocialError = function(error){
		LoaderService.Hide();

		$ionicPopup.alert({ title: error, });
	};



$scope.facebookLogin = function() {

        $cordovaOauth.facebook("FB_CODE", ["email", "public_profile", "user_friends"]).then(function(result) {
          $state.go('main/dash', {}, {reload: true});
          $scope.access_token = result.access_token;
          //$scope.setCurrentUsername(data.username);
        }, function(error) {
                  var alertPopup = $ionicPopup.alert({
                  title: 'Login failed!',
                  template: 'There was a problem signing in!',
                  buttons:[{
                    type: 'button-assertive',
                    text: 'OK!'
                  }]
                });
        });
  }


$scope.googleLogin = function() {
    $cordovaOauth.google(GOOGLE_PLUS_CODE, ["https://www.googleapis.com/auth/urlshortener", "https://www.googleapis.com/auth/userinfo.email"]).then(function(result) {
    //console.log("Response Object -> " + JSON.stringify(result));
    $state.go('main/dash', {}, {reload: true});
    }, function(error) {
            var alertPopup = $ionicPopup.alert({
            title: 'Login failed!',
            template: 'There was a problem signing in!',
            buttons:[{
              type: 'button-assertive',
              text: 'OK!'
            }]
          });
        });
  }
	


	$scope.FBLogin = function(){
		$cordovaOauth.facebook(facebookApi, ["public_profile", "email"]).then(function(result){
			LoaderService.Show();
			$http.get("https://graph.facebook.com/v2.2/me", { params: { access_token: result.access_token, fields: "name,email,gender,location,picture", format: "json" } }).then(function(data){
				var profileInfo = data.data, userData = {
					email: profileInfo.email,
					password: profileInfo.id,
					age: 1, name: profileInfo.name,
					gender: profileInfo.gender ? profileInfo.gender : 'male',
					socialId: profileInfo.id, social: 1,
					deviceId: $scope.deviceId,
				};

				$scope.SocialLogin(userData);
			}, $scope.SocialError);

		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};


	$scope.GoogleLogin = function(){

		$cordovaOauth.google(googleApi, ["https://www.googleapis.com/auth/userinfo.profile", "https://www.googleapis.com/auth/userinfo.email"]).then(function(result){

			try{
				LoaderService.Show();
				$http({ url: 'https://www.googleapis.com/oauth2/v3/userinfo', method: 'GET', params: { access_token: result.access_token, }, }).then(function(data){

					var profileInfo = data.data, userData = {
						email: profileInfo.email,
						password: profileInfo.sub,
						age: 1, name: profileInfo.name,
						gender: profileInfo.gender ? profileInfo.gender : 'male',
						socialId: profileInfo.sub, social: 0,
						deviceId: $scope.deviceId,
					};

					$scope.SocialLogin(userData);
				}, $scope.SocialError);

			}

			catch(err){
				LoaderService.Hide();
				$ionicPopup.alert({ title: err.error, template: err, });
			}
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};


})

*/





//=== Forgot Controller ===//
.controller("Forgot", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
	$scope.forgotData = {};
	$scope.Forgot = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/forgot", data).success(function(res){
					LoaderService.Hide();
					if(res.status){
						$ionicPopup.alert({ title: res.message, });
						$state.go('reset', { email: data.email, }, { reload: true, });
					}else{ $ionicPopup.alert({ title: res.error, }); };
				}).error($scope.error);
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
})
//=== ResetPwd Controller ===//
.controller("ResetPwd", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi){
	$scope.$state = $state;
	$scope.apiEmail = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	if($scope.apiEmail && $scope.apiToken){ $state.go("app.home", {}, { reload: true, }); };
	if(!$stateParams.email){ $state.go("forgot", {}, { reload: true, }); }
	$scope.resetData = { email: $stateParams.email, };
	$scope.error = function(err){
		if(err.expired){ $state.go("forgot", {}, { reload: true, }); }
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
	$scope.Reset = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/verify-token", data).success(function(res){
					LoaderService.Hide();
					if(res.status){
						$ionicPopup.alert({ title: res.message, });
						$state.go('login', {}, { reload: true, });
					}else{ $ionicPopup.alert({ title: res.error, }); };
				}).error($scope.error);
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
})
//=== ProposCtrl Controller ===//
.controller("ProposCtrl", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaContacts, $cordovaGeolocation, apiUrl){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.delete_cookie = function(name){ document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;'; };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.Logout = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/logout?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			LoaderService.Hide();
			if(res.status){ $scope.deleteSession(); }
			else{ $ionicPopup.alert({ title: res.error, }); }
		}).error(function(err, status){
			if(status == 401){ $scope.deleteSession(); }
			else{
				var error = err.error;
				if(err.validation){
					error = "";
					angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
				}
				$ionicPopup.alert({ title: error, });
				LoaderService.Hide();
			}
		});
	};

	$scope.Profile = function(){ $state.go('app.profile', {}, { reload: true, }); };
// propose function  app.profile means that state name so we want to change into app.update

	$scope.Propos = function(){ $state.go('propos.home', {}, { reload: true, }); };

	$scope.getAllContacts = function(){
		var opts = { filter: '', multiple: true, fields: ['displayName', 'name'], };
		if(ionic.Platform.isAndroid()){ opts.hasPhoneNumber = true; /* hasPhoneNumber only works for android. */ };
		try{
			/*$cordovaContacts.find(opts).then(function(allContacts){ //omitting parameter to .find() causes all contacts to be returned
				console.log(JSON.stringify(allContacts));
			});*/
			$cordovaContacts.pickContact().then(function(contactPicked){
				/*alert(contactPicked.phoneNumbers.length);
				alert(contactPicked.emails.length);
				alert(contactPicked.displayName);*/
				$ionicPopup.alert({ template: "phoneNumbers: " + contactPicked.phoneNumbers.length + "<br>displayName: "  + contactPicked.displayName, });
			});
		}catch(err){ $ionicPopup.alert({ title: err.error, template: err, }); }
	};
	$scope.getLocation = function(){
		LoaderService.Show();
		$cordovaGeolocation.getCurrentPosition({ enableHighAccuracy: false, timeout: 10000, maximumAge: 0, }).then(function(position){
			alert(
				'Latitude: ' + position.coords.latitude + '\n' +
				'Longitude: ' + position.coords.longitude + '\n' +
				'Altitude: ' + position.coords.altitude + '\n' +
				'Accuracy: ' + position.coords.accuracy + '\n' +
				'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
				'Heading: ' + position.coords.heading + '\n' +
				'Speed: ' + position.coords.speed + '\n' +
				'Timestamp: ' + position.timestamp + '\n'
			);
			LoaderService.Hide();
		}, function(error){
			alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
			LoaderService.Hide();
		});
	};
})
//=== Propos Home Controller ===//
.controller("Propos", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
//app.home  means home.html

	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
})
//=== AppCtrl Controller ===//
.controller("AppCtrl", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $interval, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaContacts, $cordovaLocalNotification, $cordovaGeolocation, apiUrl, LocationService, PubNubService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.delete_cookie = function(name){ document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;'; };
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url.replace("/image/", "/image/thumbnail/"); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.Logout = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/logout?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			LoaderService.Hide();
			if(res.status){
				$interval.cancel(promise1);
				$interval.cancel(promise2);
				$scope.deleteSession();
			}else{ $ionicPopup.alert({ title: res.error, }); }
		}).error(function(err, status){
			if(status == 401){ $scope.deleteSession(); }
			else{
				var error = err.error;
				if(err.validation){
					error = "";
					angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
				}
				$ionicPopup.alert({ title: error, });
				LoaderService.Hide();
			}
		});
	};
	$scope.goTo = function(state){
		if($state.current.name != state){
			LoaderService.Show();
			$state.go(state, {}, { reload: true, });
		}
	};
	$scope.$on("updateAuthUser", function(event, user, sports){
		$scope.authuser = user;
		$scope.sports = sports;
		if(!$scope.$$phase){ $scope.$apply(); }
	});
	$scope.getAllContacts = function(){
		var opts = { filter: '', multiple: true, fields: ['displayName', 'name'], };
		if(ionic.Platform.isAndroid()){ opts.hasPhoneNumber = true; /* hasPhoneNumber only works for android. */ };
		try{
			$cordovaContacts.pickContact().then(function(contactPicked){
				/*alert(contactPicked.phoneNumbers.length);alert(contactPicked.emails.length);alert(contactPicked.displayName);*/
				$ionicPopup.alert({ template: "phoneNumbers: " + contactPicked.phoneNumbers.length + "<br>displayName: "  + contactPicked.displayName, });
			});
		}catch(err){ $ionicPopup.alert({ title: err.error, template: err, }); }
	};
	$rootScope.$on('$cordovaLocalNotification:click', function(event, notification, state){
		var value = JSON.parse(notification.data);
		if(value.inviteNotification && value.goToMatch){
			var match = value.match;
			if(match){ $state.go("app.matchView", { matchId: match.id, }, { reload: true, }); }
		};
		if(value.messageNotification && value.goToMatchChat){
			var message = value.message;
			if(message){ $state.go("app.matchChat", { matchId: message.match, }, { reload: true, }); }
		};
		if(value.messageNotification && value.goToFriendChat){
			var message = value.message;
			if(message){ $state.go("app.chatFriend", { friendId: message.friend, }, { reload: true, }); }
		};
	});
	PubNubService.addListener({
		status: function(statusEvent){
			if(statusEvent.category === "PNUnknownCategory"){
				var newState = { new: 'error', };
				PubNubService.setState({ state: newState, }, function(status){
					console.log(statusEvent.errorData.message)
				});
			}
		},
		message: function(res){
			var isNotify = true, states = ['app.matchChat', 'app.chat', 'app.chatFriend', ];
			for(var i = 0; i < states.length; i++){ if($state.current.name == states[i]){ isNotify = false; } };
			if(isNotify && $window.cordova && $window.cordova.plugins){
				if(res.message.isMatchChat && res.message.user != $scope.authuser.id){
					$cordovaLocalNotification.schedule({
						id: res.message.match + res.message.user + $scope.authuser.id,
						title: 'New Message From - ' + res.message.userName,
						text: res.message.message,
						data: {
							message: res.message,
							messageNotification: true,
							goToMatchChat: true,
						},
					}).then(function(result){});
				}
				if(res.message.isFriendChat && res.message.senderId != $scope.authuser.id){
					$cordovaLocalNotification.schedule({
						id: res.message.senderId + res.message.friend + res.message.receiverId,
						title: 'New Message From - ' + res.message.senderName,
						text: res.message.message,
						data: {
							message: res.message,
							messageNotification: true,
							goToFriendChat: true,
						},
					}).then(function(result){});
				}
			}
		},
		presence: function(m){ console.log(m); },
	});
	$scope.badgeCount = 0;
	$scope.$on("updateBadgeCount", function(event, notifications){
		$scope.notifications = notifications;
		$scope.badgeCount = $scope.notifications.length;
		if(!$scope.$$phase){ $scope.$apply(); }
	});
	$scope.watchNotification = function(){
		$http.get(apiUrl + "/api/v1/notification?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			$scope.authuser = res.user;
			$scope.notifications = res.notifications;
			$scope.badgeCount = $scope.notifications.length;
		}).error(function(){
			$interval.cancel(promise1);
			$interval.cancel(promise2);
		});

	};
	$scope.watchLocation = function(){
		/*$rootScope.watch = $cordovaGeolocation.watchPosition({ enableHighAccuracy: false, timeout: 10000, maximumAge: 300000, });
		$rootScope.watch.then(null, function(error){}, function(position){
			LocationService.postLocation(apiUrl, $scope.apiToken, { lat: position.coords.latitude, long: position.coords.longitude, });
		});*/
		$cordovaGeolocation.getCurrentPosition({ enableHighAccuracy: false, timeout: 10000, maximumAge: 0, }).then(function(position){
			LocationService.postLocation(apiUrl, $scope.apiToken, { lat: position.coords.latitude, long: position.coords.longitude, }).error(function(){
				$interval.cancel(promise1);
				$interval.cancel(promise2);
			});
		}, function(error){});
	};
	$scope.watchNotification();
	$scope.watchLocation();
	var promise1 = $interval($scope.watchNotification, 60000);
	var promise2 = $interval($scope.watchLocation, 600000);
})
//=== Notification Controller ===//
.controller("Notification", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, apiUrl, $cordovaCamera, $ionicModal, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.success = function(res){
		$scope.currentUser = $rootScope.currentUser = res.user;
		$scope.inputDate = new Date($scope.currentUser.birthdate);
		$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
		$scope.currentUser.sport_id = String($scope.currentUser.sport_id);
		$window.localStorage.setItem('email', res.user.email);
		$window.localStorage.setItem('api_token', res.user.api_token);
		$window.localStorage.setItem('user', JSON.stringify(res.user));
		$window.sessionStorage.currentEmail = res.user.email; // Access Token details
		$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
		$window.sessionStorage.user_id = res.user.id;
		$scope.authuser = $scope.currentUser;
		$scope.notifications = res.notifications;
		$scope.notifications.forEach(function(x){ x.created_at = new Date(x.created_at); });
		$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		$rootScope.$broadcast("updateBadgeCount", $scope.notifications);
		if(!$scope.$$phase){ $scope.$apply(); }
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.goToNotification = function(notification){
		LoaderService.Show();
		$http.post(apiUrl + "/api/v1/notification/read/" + notification.id + "?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			$scope.success(res);
			if(notification.object == "MatchInvite"){
				$state.go("app.matchView", { matchId: notification.object_id, }, { reload: true, });
			}
		}).error($scope.error);
	};
	$scope.getData = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/notification?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
	};
	$scope.getData();
})


//=== Profile Controller ===//
.controller("ProfileUpdated", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, apiUrl, $cordovaCamera, $ionicModal, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");

	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };

	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));

	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };

	$scope.posts = [{ key: "attacker", value: "Attaquant", }, { key: "middle", value: "Milieu", }, { key: "defender", value: "Défenseur", }, { key: "guardian", value: "Gardien", }];

	$scope.post = "Select Poste";

	$scope.genders = [{ key: "male", value: "Homme", }, { key: "female", value: "Femme", }];


	$scope.deleteSession = function(){

		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();

		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};


	$scope.success = function(res){
		if(res.status){

			$rootScope.currentUser = res.data;
			$scope.inputDate = new Date($scope.currentUser.birthdate);
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$scope.currentUser.sport_id = String($scope.currentUser.sport_id);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.data.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.data.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			$scope.authuser = $scope.currentUser;
			$scope.sports = res.sports;

			$rootScope.$broadcast("updateAuthUser", $scope.currentUser, $scope.sports);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.$watch(function(){
				return $scope.currentUser.post;
			}, function(){
				var postOptions = { "attacker": "Attaquant", "middle": "Milieu", "defender": "Défenseur", "guardian": "Gardien", };
				$scope.post = postOptions[$scope.currentUser.post];
			}, true);
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};


	$scope.formatDate = function(date){
		var dateOut = new Date(date);
		return dateOut;
	};

	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};


	$scope.getData = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
	};


	$scope.openDatePicker = function(){
		ionicDatePicker.openDatePicker({
			callback: function(val){
				$scope.inputDate = new Date(val);
				$scope.currentUser.birthdate = moment(val).format("DD/MM/YYYY");
			},
			from: moment().subtract("110", "years"),
			to: new Date(),
			inputDate: $scope.inputDate,
			mondayFirst: false,
			closeOnSelect: true,
			dateFormat: 'dd/MM/yyyy',
			templateType: 'popup',
			titleLabel: 'Sélectionnez une date',
			setLabel: 'Définir',
			todayLabel: 'Aujourd\'hui',
			closeLabel: 'Fermer',
			weeksList: [ "D","L","M","M","J","V","S" ],
			monthsList: [ "janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc." ],
		});
	};


	$scope.ImageUrl = function(url){ return apiUrl + '/' + url.replace('/image/', '/image/thumbnail/'); };


	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 30, allowEdit: false,
			destinationType: Camera.DestinationType.DATA_URL,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};


		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			$scope.currentUser.imageData = "data:image/jpeg;base64," + imageData;
			$scope.currentUser.hasImage = true;
			if(!$scope.$$phase){ $scope.$apply(); }
			LoaderService.Hide();
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});


	};


	$scope.Update = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				if($scope.image && $scope.fileName){
					var options = { fileKey: "photo", fileName: $scope.fileName, chunkedMode: false, mimeType: "image/png", params: data, };
					var Url = apiUrl + "/api/v1/profile?api_token=" + $scope.apiToken;
					$cordovaFileTransfer.upload(Url, $scope.image, options).then(function(res){
						$state.go("app.matchs", {}, { reload: true, });
					}, function(res){
						var status = res.http_status, err = JSON.parse(res.body);
						$scope.error(err, status);
					}, function(progress){});
				}else{
					$http.post(apiUrl + "/api/v1/profile?api_token=" + $scope.apiToken, data, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
						LoaderService.Hide();
						if(res.status){
							res.data.birthdate = moment(res.data.birthdate).format("DD/MM/YYYY");
							$rootScope.$broadcast("updateAuthUser", res.data);
							$state.go("app.matchs", {}, { reload: true, });
						}else{ $ionicPopup.alert({ title: res.error, }); };
					}).error($scope.error);
				}
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};


	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 50, allowEdit: false,
			destinationType: Camera.DestinationType.FILE_URI,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};
		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			window.resolveLocalFileSystemURI(imageData, function(fileEntry){
				fileEntry.file(function(filee){
					$scope.image = imageData;
					$scope.fileName = filee.name;
					if(!$scope.$$phase){ $scope.$apply(); }
					LoaderService.Hide();
				}, function(error){
					LoaderService.Hide();
					$ionicPopup.alert({ title: error, });
				});
			},  function(error){
				LoaderService.Hide();
				$ionicPopup.alert({ title: error, });
			});
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});
	};


	$scope.getOption = function(option){ return option.key; };
	$scope.getData();

})


/*
.controller("ProfileUpdated", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, apiUrl, $cordovaCamera, $ionicModal, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer){	$scope.$state = $state;
	
	
console.log("test");



	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 50, allowEdit: false,
			destinationType: Camera.DestinationType.FILE_URI,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};
		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			window.resolveLocalFileSystemURI(imageData, function(fileEntry){
				fileEntry.file(function(filee){
					$scope.image = imageData;
					$scope.fileName = filee.name;
					if(!$scope.$$phase){ $scope.$apply(); }
					LoaderService.Hide();
				}, function(error){
					LoaderService.Hide();
					$ionicPopup.alert({ title: error, });
				});
			},  function(error){
				LoaderService.Hide();
				$ionicPopup.alert({ title: error, });
			});
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});
	};



})
*/





//=== Home Controller ===//
.controller("Home", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaGeolocation, $cordovaLocalNotification, apiUrl, PubNubService, resource){


	$ionicHistory.clearHistory();
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");


	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));

	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();

		$window.localStorage.setItem('login_email', $scope.loginData.email);

		$window.localStorage.setItem('login_password', $scope.loginData.password);

		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};




	$scope.success = function(res){
		if(res.status){
			$scope.authuser = $rootScope.currentUser = res.data;
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.data.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.data.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			$scope.sports = res.sports;
			$scope.cssStyle = { height: (100 / $scope.sports.length) + "%", };
			$scope.invites = res.invites;



			if($window.cordova && $window.cordova.plugins && $scope.invites){
				angular.forEach($scope.invites, function(value, key){
					$cordovaLocalNotification.schedule({
						id: value.id + value.sport.id + value.user.id + $scope.authuser.id,
						title: value.user.name + ' - Inviter ' + value.name,
						text: value.user.name + ' - Inviter ' + value.name + ' to play ' + value.sport.name,
						data: {
							message: value,
							inviteNotification: true,
							goToMatch: true,
						},
					}).then(function(result){});
				});
			}
			$scope.channels = res.channels;
			angular.forEach($scope.channels, function(channel, key){ PubNubService.subscribe({ channels: [channel], withPresence: true, }); });
			$rootScope.$broadcast("updateAuthUser", $scope.authuser, $scope.sports);
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.backgroundImage = function(sport){
		// var url = apiUrl + '/' + sport.image.replace('/image/', '/image/thumbnail/');
		var url = apiUrl + '/' + sport.image;
		return { 'background-image': "url('" + url + "')", };
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.goToSport = function(sportId){
		if(sportId){
			$http.post(apiUrl + "/api/v1/change-sport?api_token=" + $scope.apiToken, { "sport_id": sportId, }, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				if(res.status){ $state.go("app.rejoin", {}, { reload: true, }); }
				else{
					LoaderService.Hide();
					$ionicPopup.alert({ title: res.error, });
				};
			}).error($scope.error);
		}
	};


	$scope.ImageUrl = function(url){ return apiUrl + '/' + url.replace('/image/', '/image/thumbnail/'); };
	if($scope.email || $scope.apiToken){
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	}else{ $state.go("login", {}, { reload: true, }); };
})


//=== Create Match Controller ===//
.controller("CreateMatch", function($rootScope, $window, $cordovaGoogleAnalytics, $state, $scope, $q, LoaderService, $ionicModal, $cordovaContacts, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, $cordovaCamera, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer, $cordovaDatePicker, $cordovaFacebook, $cordovaSocialSharing, facebookApi, resource, fbContacts){
	// tu as choisi de jouer dans un centre non partenaire :n'oublie pas d'appeler le club pour réserver ton terrain.
	LoaderService.Show();
	$scope.scheme = false;
	$scope.$state = $state;

	if(typeof appAvailability !== 'undefined'){
		var scheme = 'com.whatsapp';
		if(ionic.Platform.isIOS()){ scheme = 'whatsapp://'; };
		appAvailability.check(scheme, function(){
			$scope.scheme = true;
		}, function(){
			$scope.scheme = false;
		});
	};
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchData = { visibility: 'public', };
	$scope.pageTitle = "Créer un match";
	$scope.pageView = 1;
	$scope.teamTitle = "Défier une équipe";
	$scope.playerTitle = "Nombre de joueurs 10";
	if(window.analytics){ $cordovaGoogleAnalytics.trackView('Create Match'); };
	$scope.$watch(function(){ return $scope.matchData.players; }, function(){ if($scope.matchData.players){ $scope.playerTitle = $scope.matchData.players; } }, true);
	$scope.$watch(function(){ return $scope.matchData.team_id; }, function(){
		angular.forEach($scope.teams, function(value, key){ if($scope.matchData.team_id == value.id){ $scope.teamTitle = value.name; }; });
	}, true);
	$scope.isSimpleDouble = false;
	$scope.numbers = [];
	for(var i = 1; i <= 10; i++){ $scope.numbers.push(i); };
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.inputDate = new Date();
	// $scope.inputTime = new Date();
	$scope.inputTime = (((new Date()).getHours() * 60 * 60) + ((new Date()).getMinutes() * 60));
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$scope.users = res.users;
			$scope.venues = res.venues;
			$scope.teams = res.teams;
			if($scope.isSimpleDouble == true){
				$scope.matchData.type = "simple";
				$scope.matchData.players = 2;
			};
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.allContacts = [];
	$scope.fbContacts = [];
	$scope.getDetails = function(){
		LoaderService.Show();
		if(fbContacts.success){ $scope.fbContacts = fbContacts.data; };
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	};		
	$scope.getData = function(){
		try{
			if(window.cordova && window.cordova.plugins){
				$cordovaContacts.find({ filter: '', multiple: true, fields: ['displayName', 'name'], }).then(function(allContacts){
					angular.forEach(allContacts, function(contact, key){
						if(angular.isArray(contact.emails) && contact.emails.length > 0){
							angular.forEach(contact.emails, function(Econtact, Ekey){
								$scope.allContacts.push({ isContact: true, name: contact.displayName, email: Econtact.value, });
							});
						}
					});
					$scope.getDetails();
				}, function(err){
					$ionicPopup.alert({ title: err.error, template: err, });
					$state.go("app.home", {}, { reload: true, });
				});
			}else{ $scope.getDetails(); }
		}catch(err){ $ionicPopup.alert({ title: err.error, template: err, }); }
	};
	$scope.openDatePicker = function(){
		ionicDatePicker.openDatePicker({
			callback: function(val){
				$scope.inputDate = new Date(val);
				var options = {
					callback: function(valTime){
						if(typeof (valTime) === 'undefined'){ $scope.openDatePicker(); }
						else{
							$scope.inputTime = valTime;
							$scope.matchData.datetime = moment(val).format("DD/MM/YYYY") + " " + moment.utc(valTime * 1000).format("HH:mm");
						}
					},
					inputTime: $scope.inputTime,
					format: 24,
					step: 10,
					setLabel: 'Définir',
					closeLabel: 'Fermer',
				};
				ionicTimePicker.openTimePicker(options);
			},
			from: moment().add(1, "day"),
			to: moment().add(10, "years"),
			inputDate: $scope.inputDate,
			mondayFirst: false,
			closeOnSelect: true,
			dateFormat: 'dd/MM/yyyy',
			templateType: 'popup',
			titleLabel: 'Sélectionnez une date',
			setLabel: 'Définir',
			todayLabel: 'Aujourd\'hui',
			closeLabel: 'Fermer',
			weeksList: [ "D","L","M","M","J","V","S" ],
			monthsList: [ "janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc." ],
		});
		/*var defaultDate = (ionic.Platform.isIOS() ? new Date() : new Date().getTime());
		$cordovaDatePicker.show({
			date: $scope.inputDate,
			mode: 'date',
			minDate: defaultDate,
			allowOldDates: false,
			allowFutureDates: true,
			doneButtonLabel: 'Définir',
			doneButtonColor: '#01a3e3',
			cancelButtonLabel: 'Fermer',
			cancelButtonColor: '#01a3e3',
			cancelText: 'Fermer',
			okText: 'Définir',
		}).then(function(date){
			$scope.inputDate = new Date(date);
			$cordovaDatePicker.show({
				date: $scope.inputTime,
				mode: 'time',
				allowOldDates: false,
				allowFutureDates: true,
				doneButtonLabel: 'Définir',
				doneButtonColor: '#01a3e3',
				cancelButtonLabel: 'Fermer',
				cancelButtonColor: '#01a3e3',
				cancelText: 'Fermer',
				okText: 'Définir',
			}).then(function(val){
				$scope.inputTime = val;
				$scope.matchData.datetime = moment(date).format("DD/MM/YYYY") + " " + moment(val).format("HH:mm");
			});
		});*/
	};
	$scope.changeVisibility = function(visibility){ $scope.matchData.visibility = visibility; };
	$scope.changeType = function(type){
		$scope.matchData.players = 4;
		if(type == 'simple'){ $scope.matchData.players = 2; }
		$scope.matchData.type = type;
	};
	$scope.fbShare = function(matchData){
		if($scope.fbInvities.length > 0){
			/*facebookConnectPlugin.appInvite({
				appLinkURL: https://fb.me/746928768795507
				url: "http://example.com",
				picture: "http://example.com/image.png"
			}, function(obj){
				if(obj){
					if(obj.completionGesture == "cancel"){
						// user canceled, bad guy
					}else{
						// user really invited someone :) 
					}
				}else{
					// user just pressed done, bad guy 
				}
			}, function(err){ alert(JSON.stringify(err)); });*/
			facebookConnectPlugin.showDialog({
				method: "share",
				picture: 'https://scontent.fmaa2-1.fna.fbcdn.net/t39.2081-0/p168x128/15945747_744449809043403_2404151383235231744_n.png',
				name: matchData.match.name + ' - DoInSport',
				message: matchData.match.name,
				description: matchData.shareFBMessage,
			}, function(res){
				$state.go("app.matchs", {}, { reload: true, }); 
			}, function(err){
				$ionicPopup.alert({ title: err.errorMessage, });
				$state.go("app.matchs", {}, { reload: true, }); 
			});
			/*$cordovaFacebook.getAccessToken().then(function(token){
				openFB.init({ appId: facebookApi, accessToken: token, });
				openFB.api({
					method: 'POST',
					path: '/me/feed',
					params: {
						message: 'Testing Facebook APIs',
						// tags: 
					},
					success: function(){
						alert('the item was posted on Facebook');
					},
					error: function(err){
						alert(JSON.stringify(err));
					},
				});
			}, function(err){
				alert(JSON.stringify(err));
			});*/
		}else{ $state.go("app.matchs", {}, { reload: true, }); }
	};
	$scope.Create = function(form, data){
		if(!$scope.matchData.image){ $ionicPopup.alert({ title: "Sélectionnez d'abord l'image!", }); }
		else if(!$scope.matchData.venue_id){ $ionicPopup.alert({ title: "Sélectionnez d'abord Votre Centre!", }); }
		else if(form.$valid && data.players){
			try{
				var parameters = { name: data.name, visibility: data.visibility, datetime: data.datetime,
					venue_id: data.venue_id, team_id: data.team_id, players: data.players,
					level: data.level, type: data.type,
				};
				if($scope.matchData.invities.length > 0){ parameters.invities = data.invities; }
				LoaderService.Show();
				var options = {
					fileKey: "image",
					fileName: $scope.fileName,
					chunkedMode: false,
					mimeType: "image/png",
					params: parameters,
				};
				var Url = apiUrl + "/api/v1/match/create?api_token=" + $scope.apiToken;
				$cordovaFileTransfer.upload(Url, $scope.matchData.image, options).then(function(res){
					if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('MatchCreation', 'Match Creation', "Name", data.name); };
					var matchData = JSON.parse(res.response);
					// $state.go("app.matchs", {}, { reload: true, });
					$scope.fbShare(matchData);
				}, function(res){
					var status = res.http_status;
					if(status == 401){ $scope.deleteSession(); }
					else{
						var err = JSON.parse(res.body);
						if(err.validation){
							var error = "";
							angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
							$ionicPopup.alert({ title: error, });
						}else{
							var error = err.error;
							$ionicPopup.alert({ title: error, });
						}
						if(err.redirect){
							$backView = $ionicHistory.backView();
							if($backView){ $backView.go(); }
							else{ $scope.gotohome(); }
						}
						LoaderService.Hide();
					}
				}, function(progress){});
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
	$scope.matchData.invities = [];
	$scope.matchData.level = 3;
	$scope.ratingsObject = {
		iconOn: 'ion-ios-star',
		iconOff: 'ion-ios-star-outline',
		iconOnColor: 'rgb(255, 215, 0)',
		iconOffColor:  'rgb(255, 215, 0)',
		rating: $scope.matchData.level,
		minRating: 1,
		callback: function(level, index){
			$scope.matchData.level = level;
			if(!$scope.$$phase){ $scope.$apply(); }
		}
	};
	$scope.changeInvite = function(invite, value){
		var isInvited = false;
		for(var i = 0; i < $scope.matchData.invities.length; i++){
			if(String($scope.matchData.invities[i]) == String(value)){
				invite.checked = false;
				$scope.matchData.invities.splice(i, 1);
				isInvited = true;
				break;
			}
		};
		if(!isInvited && $scope.matchData.invities.length < $scope.matchData.players - 1){
			invite.checked = true;
			$scope.matchData.invities.push(value);
		}
	};
	$scope.fbInvities = [];
	$scope.changeFbInvite = function(invite, value){
		var isInvited = false;
		for(var i = 0; i < $scope.fbInvities.length; i++){
			if(String($scope.fbInvities[i]) == String(value)){
				invite.checked = false;
				$scope.fbInvities.splice(i, 1);
				isInvited = true;
				break;
			}
		};
		if(!isInvited){
			invite.checked = true;
			$scope.fbInvities.push(value);
		}
	};
	$scope.getOption = function(option){ return option.id; };
	$scope.fileName = "Importer la photo";
	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 50, allowEdit: false,
			destinationType: Camera.DestinationType.FILE_URI,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};
		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			window.resolveLocalFileSystemURI(imageData, function(fileEntry){
				fileEntry.file(function(filee){
					$scope.matchData.image = imageData;
					$scope.fileName = filee.name;
					if(!$scope.$$phase){ $scope.$apply(); }
					LoaderService.Hide();
				}, function(error){
					LoaderService.Hide();
					$ionicPopup.alert({ title: error, });
				});
			},  function(error){
				LoaderService.Hide();
				$ionicPopup.alert({ title: error, });
			});
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});
	};
	$scope.ShowInvite = function(form, data){
		if(form.$valid && data.players){
			$scope.showContacts = 1;
			LoaderService.Show();
			$scope.pageTitle = "Inviter des joueurs";
			$scope.pageView = 2;
			$ionicScrollDelegate.scrollTop();
			LoaderService.Hide();
		}else{ $ionicPopup.alert({ title: "Veuillez entrer les détails du match en premier!", }); }
	};
	$scope.changeView = function(num, data){
		if($scope.pageView == 2){
			if(num == 3){
				if(!$scope.matchData.image){ $ionicPopup.alert({ title: "Sélectionnez d'abord l'image!", }); }
				else if(!$scope.matchData.venue_id){ $ionicPopup.alert({ title: "Sélectionnez d'abord Votre Centre!", }); }
				else if(data.players){
					var parameters = { name: data.name, visibility: data.visibility, datetime: data.datetime,
						venue_id: data.venue_id, team_id: data.team_id, players: data.players,
						level: data.level, type: data.type,
					};
					if($scope.matchData.invities.length > 0){ parameters.invities = data.invities; }
					LoaderService.Show();
					var options = { fileKey: "image", fileName: $scope.fileName, chunkedMode: false, mimeType: "image/png", params: parameters, };
					$cordovaFileTransfer.upload(apiUrl + "/api/v1/match/create?api_token=" + $scope.apiToken, $scope.matchData.image, options).then(function(res){
						var matchData = JSON.parse(res.response);
						if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('MatchCreation', 'Match Creation', "Name", data.name); };
						$cordovaSocialSharing.shareViaWhatsApp(matchData.shareWMessage, null, null).then(function(result){
							alert("Inviter ses contacts whatsapp au match Terminé");
							// $state.go("app.matchs", {}, { reload: true, });
							$scope.fbShare(matchData);
						}, function(err){
							$ionicPopup.alert({ title: error, });
							$state.go("app.matchs", {}, { reload: true, });
						});
					}, function(res){
						var status = res.http_status;
						if(status == 401){ $scope.deleteSession(); }
						else{
							var err = JSON.parse(res.body);
							if(err.validation){
								var error = "";
								angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
								$ionicPopup.alert({ title: error, });
							}else{
								var error = err.error;
								$ionicPopup.alert({ title: error, });
							}
							if(err.redirect){
								$backView = $ionicHistory.backView();
								if($backView){ $backView.go(); }
								else{ $scope.gotohome(); }
							}
							LoaderService.Hide();
						}
					}, function(progress){});
				}
			}else{ $scope.showContacts = num; };
		};
	};
	$scope.HideInvite = function(){
		LoaderService.Show();
		$scope.pageTitle = "Créer un match";
		$scope.pageView = 1;
		$ionicScrollDelegate.scrollTop();
		LoaderService.Hide();
	};
	$scope.ShowVenue = function(){
		$scope.pageTitle = "Choisir son centre";
		$scope.pageView = 3;
		$ionicScrollDelegate.scrollTop();
	};
	$scope.chooseText = "Choisissez Votre Centre";
	$scope.selectVenue = function(venue){
		if(venue){
			$scope.chooseText = venue.name;
			$scope.matchData.venue_id = venue.id;
			$scope.pageTitle = "Créer un match";
			$scope.pageView = 1;
			$ionicScrollDelegate.scrollTop();
		}
	};
	$scope.getData();
})

//=== Match Invite Controller ===//
.controller("MatchInvite", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.getData();
})

//=== Match List Controller ===//
.controller("Matchs", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService, $cordovaFacebook){
	/*$cordovaFacebook.getLoginStatus().then(function(success){
		alert(JSON.stringify(success));
	}, function (error){
		alert(JSON.stringify(error));
	});*/
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.matchs.forEach(function(x){
				x.datetime = new Date(x.datetime);
			});
			$scope.channels = res.channels;
			angular.forEach($scope.channels, function(channel, key){ PubNubService.subscribe({ channels: [channel], withPresence: true, }); });
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacths(apiUrl, $scope.apiToken).success($scope.success).error($scope.error);
	};
	$scope.goToCreateMatch = function(){
		$state.go("app.createMatch", {}, { reload: true, });
	};
	$scope.goToMatch = function(match){
		if(match){ $state.go("app.matchView", { matchId: match.id, }, { reload: true, }); }
	};
	$scope.getData();
})
//=== Post Match List Controller ===//
.controller("PostMatch", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.matchs.forEach(function(x){
				x.datetime = new Date(x.datetime);
			});
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getPostMacths(apiUrl, $scope.apiToken).success($scope.success).error($scope.error);
	};
	$scope.goToMatch = function(match){
		if(match){ $state.go("app.matchView", { matchId: match.id, }, { reload: true, }); }
	};
	$scope.getData();
})
//=== Rejoin Match List Controller ===//
.controller("Rejoin", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.matchs.forEach(function(x){
				x.datetimeS = moment(x.datetime, "YYYY-MM-DD HH:mm:ss").format("ddd D MMM - HH[H]mm");
				x.ratingsObject = {
					iconOn: 'ion-ios-star',
					iconOff: 'ion-ios-star-outline',
					iconOnColor: 'rgb(255, 215, 0)',
					iconOffColor:  'rgb(255, 215, 0)',
					rating: x.level,
					minRating: 1,
					readOnly: true,
					callback: function(rating, index){},
				}
			});
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getRejoinMacths(apiUrl, $scope.apiToken).success($scope.success).error($scope.error);
	};
	$scope.Participate = function(match){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, match.id).success(function(res){
			if(res.status){
				angular.forEach($scope.matchs, function(val, key){
					if(String(match.id) == String(val.id)){
						$scope.matchs.splice(key, 1);
					}
				});
			}else{ $ionicPopup.alert({ title: res.error, }); };
			LoaderService.Hide();
		}).error($scope.error);
	};
	$scope.goToMatch = function(match){
		if(match){
			$state.go("app.matchRejoin", { matchId: match.id, }, { reload: true, });
		}
	};
	$scope.getData();
})
//=== Match Rejoin Controller ===//
.controller("MatchRejoin", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){
				$scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true;
			}
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getJoinMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){ $state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, }); };
	$scope.swipeRight = function(){ $state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, }); };
	$scope.swipeLeft = function(){ $state.go("app.matchRejoinSlot", { matchId: $scope.match.id, }, { reload: true, }); };
	$scope.getData();
})
//=== Match Rejoin Slot Controller ===//
.controller("MatchRejoinSlot", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.joinAvailable = false;
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.team = res.team;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			$scope.joinAvailable = (!$scope.match.matchplayer) ? true : false;
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success(function(res){
			if(res.status){
				$state.go("app.matchView", { matchId: $scope.match.id, }, { reload: true, });
			}else{
				$ionicPopup.alert({ title: res.error, });
				LoaderService.Hide();
			};
		}).error($scope.error);
	};
	$scope.postMacthJoinSide = function(){
		LoaderService.Show();
		MatchService.postMacthJoinSide(apiUrl, $scope.apiToken, $scope.matchId).success(function(res){
			if(res.status){
				$state.go("app.matchView", { matchId: $scope.match.id, }, { reload: true, });
			}else{
				$ionicPopup.alert({ title: res.error, });
				LoaderService.Hide();
			};
		}).error($scope.error);
	};
	$scope.getNumber = function(count){
		var counts = [];
		if($scope.isSimpleDouble){
			if($scope.match.type == 'simple'){ for(var i = 1; i < count; i++){ counts.push(i); }; }
			else{ for(var i = 1; i < count - 1; i++){ counts.push(i); }; }
		}else{
			for(var i = 0; i < count; i++){ counts.push(i); };
		}
		console.log(counts)
		return counts;
	};
	$scope.posts = { attacker: "Attaquant", middle: "Milieu", defender: "Défenseur", guardian: "Gardien", };
	$scope.getMatchPlayers = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '0' || value.side == 0 && value.side == false){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.getMatchPlayersSide = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '1' || value.side == 1 && value.side == true){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getRejoinSlots(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){
		$state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.getData();
})
//=== Match View Controller ===//
.controller("MatchView", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){
		$state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.swipeRight = function(){
		/*if($scope.authuser.id == $scope.match.user_id){ $state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, }); }
		else{
			var isAccepted = false;
			angular.forEach($scope.match.matchplayers, function(val, key){
				if($scope.authuser.id == val.user_id && val.accept){ isAccepted = true; }
			});
			if(isAccepted){ $state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, }); }
		}*/
		$state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.swipeLeft = function(){
		/*if($scope.authuser.id != $scope.match.user_id){
			var isAccepted = false;
			angular.forEach($scope.match.matchplayers, function(val, key){ if($scope.authuser.id == val.user_id && val.accept){ isAccepted = true; } });
			if(isAccepted){ $state.go("app.matchSlot", { matchId: $scope.match.id, }, { reload: true, }); }
		}*/
		$state.go("app.matchSlot", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.shareSocial = function(){
		/*$cordovaSocialSharing.share("message", "subject", "file", "link").then(function(result){ // Share via native share sheet
			// Success!
		}, function(err){
			// An error occured. Show a message to the user
		});*/
	};
	$scope.getData();
})
//=== Match Slot Controller ===//
.controller("MatchSlot", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.joinAvailable = false;
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.team = res.team;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			// $scope.joinAvailable = 
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.getNumber = function(count){
		var counts = [];
		if($scope.isSimpleDouble){
			if($scope.match.type == 'simple'){ for(var i = 1; i < count; i++){ counts.push(i); }; }
			else{ for(var i = 1; i < count - 1; i++){ counts.push(i); }; }
		}else{
			for(var i = 0; i < count; i++){ counts.push(i); };
		}
		console.log(counts)
		return counts;
	};
	$scope.posts = { attacker: "Attaquant", middle: "Milieu", defender: "Défenseur", guardian: "Gardien", };
	$scope.getMatchPlayers = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '0' || value.side == 0 && value.side == false){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.getMatchPlayersSide = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '1' || value.side == 1 && value.side == true){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthSlots(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){
		$state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.getData();
})
//=== Match Map Controller ===//
.controller("MatchMap", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.initialise = function(){
		var mapOptions = {
			center: new google.maps.LatLng($scope.match.venue.lat, $scope.match.venue.long),
			zoom: 5, mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map = new google.maps.Map(document.getElementById("map"), mapOptions);
		$scope.map = map;
		// Additional Markers //
		$scope.markers = [];
		var infoWindow = new google.maps.InfoWindow();
		var createMarker = function(info){
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(info.lat, info.long),
				map: $scope.map, animation: google.maps.Animation.DROP,
				title: info.city,
			});
			marker.content = '<div class="infoWindowContent">' + info.desc + '</div>';
			google.maps.event.addListener(marker, 'click', function(){
				infoWindow.setContent('<h2>' + marker.title + '</h2>' + marker.content);
				infoWindow.open($scope.map, marker);
			});
			$scope.markers.push(marker);
		}  
		createMarker({
			city: $scope.match.venue.location,
			desc: $scope.match.venue.name,
			lat: $scope.match.venue.lat,
			long: $scope.match.venue.long, 
		});
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			google.maps.event.addDomListener(document.getElementById("map"), 'load', $scope.initialise());
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getJoinMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.getData();
})
//=== Event Chat Controller ===//
.controller("MatchChat", function($rootScope, $window, $state, $scope, $q, LoaderService, $filter, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $ionicScrollDelegate, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.messages = res.messages;
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			PubNubService.subscribe({ channels: [$scope.match.channel], withPresence: true, });
			$scope.addListener();
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			$ionicScrollDelegate.scrollBottom();
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthChatData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.addListener = function(){
		PubNubService.addListener({
			status: function(statusEvent){
				if(statusEvent.category === "PNUnknownCategory"){
					var newState = { new: 'error', };
					PubNubService.setState({ state: newState, }, function(status){
						console.log(statusEvent.errorData.message)
					});
				}
			},
			message: function(res){
				if(res.message.user != $scope.authuser.id && res.message.isMatchChat){
					$scope.messages.push({
						match_id: res.message.match,
						user_id: res.message.user,
						message: res.message.message,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						created: moment().format("HH[h] mm[m]"),
					});
					if(!$scope.$$phase){ $scope.$apply(); }
					$ionicScrollDelegate.scrollBottom();
				}
			},
			presence: function(m){
				console.log(m)
			},
		});
	};
	$scope.message = "";
	$scope.sendMessage = function(form, message){
		if(form.$valid){
			var data = { message: message, user: $scope.authuser.id, match: $scope.match.id, userName: $scope.authuser.name, matchName: $scope.match.name, isMatchChat: true, };
			PubNubService.publish({
				message: data,
				channel: $scope.match.channel,
			}, function(status, response){
				if(status.error){ console.log(status); }
				else{
					$http.post(apiUrl + "/api/v1/match/message/" + $scope.match.id + "?api_token=" + $scope.apiToken, data, { headers: { 'Content-Type': "application/json", }, });
					$scope.messages.push({
						match_id: $scope.match.id,
						user_id: $scope.authuser.id,
						message: message,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						match: $scope.match,
						user: $scope.authuser,
						created: moment().format("HH[h] mm[m]"),
					});
					$scope.message = "";
				}
				if(!$scope.$$phase){ $scope.$apply(); }
				$ionicScrollDelegate.scrollBottom();
			});
		}
	};
	$scope.getData();
})
//=== Sport Match List Controller ===//
.controller("SportMatch", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.sportId = $stateParams.sportId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.sport = $scope.sport;
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getSportMacths(apiUrl, $scope.apiToken, $scope.sportId).success($scope.success).error($scope.error);
	};
	$scope.goToMatch = function(match){
		if(match){
			$state.go("app.matchView", { matchId: match.id, }, { reload: true, });
		}
	};
	$scope.getData();
})
//=== Invite Friends Controller ===//
.controller("InviteFriend", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $ionicScrollDelegate, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, resource){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.search = "";
	$scope.isViewUser = 0;
	$scope.verticalHandleScroll = function(search){
		$ionicScrollDelegate.$getByHandle("verticalHandle").scrollBy(0, 0);
		if(search){
			$scope.search = search;
			$http.get(apiUrl + "/api/v1/friends/search-user?api_token=" + $scope.apiToken + "&page=1&search=" + search, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				$scope.users = [];
				for(var i = 0; i < res.users.length; i++){ $scope.users.push(res.users[i]); };
				$scope.currentPage = res.currentPage;
				if(res.lastPage > $scope.lastPage){ $scope.lastPage = res.lastPage; }
				$scope.isViewUser = 1;
			}).error($scope.error);
		}else{ $scope.isViewUser = 0; }
	};
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.getFriendUser = function(friend){
		if($scope.authuser.id == friend.friend_id){ return friend.user; }
		return friend.friend;
	};
	$scope.getMsgFriendUser = function(message){
		if($scope.authuser.id == message.sender.id){ return message.receiver; }
		return message.sender;
	};
	$scope.goToChat = function(friend){
		if(friend){ $state.go('app.chatFriend', { friendId: friend.id, }, { reload: true, }); };
	};
	$scope.addFriend = function(user){
		if(user){
			LoaderService.Show();
			$http.post(apiUrl + "/api/v1/friends/create/" + user.id + "?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				$rootScope.$broadcast("updateAuthUser", res.user);
				$state.go('app.chatFriend', { friendId: res.friend.id, }, { reload: true, });
			}).error($scope.error);
		};
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.friends = [];
	$scope.users = [];
	$scope.currentPage = 1;
	$scope.lastPage = 2;
	$scope.userLastPage = 2;
	$scope.userCurrentPage = 1;
	$scope.success = function(res){
		$scope.currentUser = $rootScope.currentUser = res.user;
		$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
		$window.localStorage.setItem('email', res.user.email);
		$window.localStorage.setItem('api_token', res.user.api_token);
		$window.localStorage.setItem('user', JSON.stringify(res.user));
		$window.sessionStorage.currentEmail = res.user.email; // Access Token details
		$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
		$window.sessionStorage.user_id = res.user.id;
		$scope.authuser = $scope.currentUser;
		$scope.messages = res.messages;
		for(var i = 0; i < res.friends.length; i++){ $scope.friends.push(res.friends[i]); };
		for(var i = 0; i < res.users.length; i++){ $scope.users.push(res.users[i]); };
		$scope.currentPage = res.currentPage;
		$scope.lastPage = res.lastPage;
		$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		if(!$scope.$$phase){ $scope.$apply(); }
		$scope.$broadcast('scroll.infiniteScrollComplete');
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		$scope.isLoading = false;
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			$scope.$broadcast('scroll.infiniteScrollComplete');
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	};
	$scope.loadMore =  function(){
		var page = ($scope.currentPage + 1);
		if(page <= $scope.lastPage){
			$http.get(apiUrl + "/api/v1/friends?api_token=" + $scope.apiToken + "&page=" + page, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
		}else{ $scope.$broadcast('scroll.infiniteScrollComplete'); }
	};
	$scope.loadMoreUser =  function(search){
		var page = ($scope.userCurrentPage + 1);
		if(page <= $scope.userLastPage && $scope.isLoading){
			$http.get(apiUrl + "/api/v1/friends/search-user?api_token=" + $scope.apiToken + "&page=" + page + "&search=" + $scope.search, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				for(var i = 0; i < res.users.length; i++){ $scope.users.push(res.users[i]); };
				$scope.userCurrentPage = res.currentPage;
				if(res.lastPage > $scope.userLastPage){ $scope.userLastPage = res.lastPage; }
				$scope.isViewUser = 1;
				$scope.isLoading = false;
			}).error($scope.error);
		}
	};
	$scope.isLoading = false;
	$scope.getScrollPosition = function(){
		if($scope.isViewUser == 1){
			$scope.isLoading = true;
			$scope.loadMoreUser($scope.search);
		};
	};
	$scope.getData();
})
//=== Friend Chat Controller ===//
.controller("FriendChat", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService, $ionicScrollDelegate, resource){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.friendId = $stateParams.friendId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		$scope.currentUser = $rootScope.currentUser = res.user;
		$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
		$window.localStorage.setItem('email', res.user.email);
		$window.localStorage.setItem('api_token', res.user.api_token);
		$window.localStorage.setItem('user', JSON.stringify(res.user));
		$window.sessionStorage.currentEmail = res.user.email; // Access Token details
		$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
		$window.sessionStorage.user_id = res.user.id;
		$scope.authuser = $scope.currentUser;
		$scope.friend = res.friend;
		$scope.messages = res.messages;
		PubNubService.subscribe({ channels: [$scope.friend.channel], withPresence: true, });
		$scope.addListener();
		$scope.friendUser = ($scope.authuser.id == $scope.friend.friend_id) ? $scope.friend.user : $scope.friend.friend;
		$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		if(!$scope.$$phase){ $scope.$apply(); }
		LoaderService.Hide();
		$timeout(function(){
			$ionicScrollDelegate.scrollBottom();
		}, 100);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.addListener = function(){
		PubNubService.addListener({
			status: function(statusEvent){
				if(statusEvent.category === "PNUnknownCategory"){
					var newState = { new: 'error', };
					PubNubService.setState({ state: newState, }, function(status){
						console.log(statusEvent.errorData.message)
					});
				}
			},
			message: function(res){
				if(res.message.senderId != $scope.authuser.id && res.message.isFriendChat){
					$scope.messages.push({
						friend_id: res.message.friend,
						sender_id: res.message.senderId,
						receiver_id: res.message.receiverId,
						message: res.message.message,
						sender: $scope.friendUser,
						receiver: $scope.authuser,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
					});
					if(!$scope.$$phase){ $scope.$apply(); }
					$ionicScrollDelegate.scrollBottom();
				}
			},
			presence: function(m){
				console.log(m)
			},
		});
	};
	$scope.message = "";
	$scope.sendMessage = function(form, message){
		if(form.$valid){
			var data = { message: message, friend: $scope.friend.id, senderId: $scope.authuser.id, senderName: $scope.authuser.name, receiverId: $scope.friendUser.id, receiverName: $scope.friendUser.name, isFriendChat: true, };
			PubNubService.publish({
				message: data,
				channel: $scope.friend.channel,
			}, function(status, response){
				if(status.error){ console.log(status); }
				else{
					$http.post(apiUrl + "/api/v1/friends/chat/" + $scope.friend.id + "?api_token=" + $scope.apiToken, data, { headers: { 'Content-Type': "application/json", }, });
					$scope.messages.push({
						friend_id: $scope.friend.id,
						sender_id: $scope.authuser.id,
						sender: $scope.authuser,
						receiver_id: $scope.friendUser.id,
						receiver: $scope.friendUser,
						message: message,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
					});
					$scope.message = "";
				}
				if(!$scope.$$phase){ $scope.$apply(); }
				$ionicScrollDelegate.scrollBottom();
			});
		}
	};
	$scope.getData = function(){
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	};
	$scope.getData();
})
//=== Chat Controller ===//
.controller("Chat", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.messages = [];
	PubNubService.history({
		channel: 'ch1',
	}, function(status, messages){
		if(status.error){ console.log("operation failed w/ status: ", status); }
		else{
			console.log(messages);
			/*angular.forEach(messages.channels['ch1'], function(val, key){
				$scope.messages.push(val);
			});*/
		}
	});
	PubNubService.addListener({
		status: function(statusEvent){
			if(statusEvent.category === "PNUnknownCategory"){
				var newState = { new: 'error', };
				PubNubService.setState({ state: newState, }, function(status){
					console.log(statusEvent.errorData.message)
				});
			}
		},
		message: function(res){
			console.log(res.message);
		},
		/*presence: function(m){
			console.log(m)
		},*/
	});
	// PubNubService.subscribe({ channels: ['ch1'], withPresence: true, });
	$scope.message = "";
	$scope.sendMessage = function(form, message){
		if(form.$valid){
			PubNubService.publish({
				message: {
					message: message,
					// user: user,
				},
				channel: 'ch1'
			}, function(status, response){
				if(status.error){
					console.log(status)
				}else{
					$scope.message = "";
				}
				if(!$scope.$$phase){ $scope.$apply(); }
			});
		}
	};

	LoaderService.Hide();
})
//=== Reglages Controller ===//
.controller("Reglages", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("login", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.usersports = res.usersports;
			/*angular.forEach($scope.usersports, function(val, key){
				val.status = (val.status || val.status == 1) ? true : false;
			});*/
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.toggleChange = function(usersport){
		$http.post(apiUrl + "/api/v1/sport/update/" + usersport.id + "?api_token=" + $scope.apiToken, usersport, { headers: { 'Content-Type': "application/json", }, }).error($scope.error);
	};
	$scope.getData = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/sport?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
	};
	$scope.getData();
})

/*.controller('MyLog', function( $scope){
	console.log("test");
*/


.controller('Login', function($rootScope, $window, $state, $scope, $cordovaGoogleAnalytics, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi, $cordovaDevice)
{
       
    $scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");

	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };

	if($scope.email && $scope.apiToken)

		{
		 $scope.gotohome();
		  };

	var strEmail = $window.localStorage.getItem('login_email');

	$scope.loginData = (strEmail != null && strEmail != 'null') ? { email: strEmail, password: $window.localStorage.getItem('login_password'), } : {};

	if(window.cordova){
	 $scope.deviceId = $cordovaDevice.getUUID(); 
	}

	else{
	 $scope.deviceId = moment().format("YYYYMMDDTHHmmssS");
	  }

	if(window.analytics){
	 $cordovaGoogleAnalytics.trackView('Login'); 
	};

	$scope.success = function(res){
		if(res.status){

			res.data.api_token = res.api_token;
			$rootScope.currentUser = res.data;
			$window.localStorage.setItem('login_email', $scope.loginData.email);
			$window.localStorage.setItem('login_password', $scope.loginData.password);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;

			if(window.analytics){
			 $cordovaGoogleAnalytics.trackEvent('Login', 'User Login', "Email", $rootScope.currentUser.email); };


			$state.go("app.home", {}, { reload: true, });
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};


	$scope.error = function(err){

		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();};


	$scope.Login = function(form, data){

		if(form.$valid){
			$scope.loginData.email = data.email;
			$scope.loginData.password = data.password;
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";

				$http.post(apiUrl + "/api/v1/auth/login", {
					email: $scope.loginData.email,
					password: $scope.loginData.password,
					deviceId: $scope.deviceId,
				}).success($scope.success).error($scope.error);
			}

			catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};


	});





















angular.module('DoinSport.controllers', [
	'ngCordovaOauth',
	'ionic-datepicker',
	'ionic-timepicker',
	'ionic-ratings',
])
//=== Land Controller ===//
.controller("Land", function($rootScope, $window, $state, $scope, $q, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $location, LoaderService, apiUrl){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.success = function(res){
		if(res.status){
			$rootScope.currentUser = res.data;
			$scope.inputDate = new Date($scope.currentUser.birthdate);
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$scope.currentUser.sport_id = String($scope.currentUser.sport_id);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.data.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.data.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			$scope.authuser = $scope.currentUser;
			if($scope.authuser.sport_id != null && $scope.authuser.sport_id != 'null' && $scope.authuser.sport_id != ''){ $state.go("app.matchs", {}, { reload: true, }); }
			else{ $state.go("app.home", {}, { reload: true, }); }
			$scope.sports = res.sports;
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser, $scope.sports);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.leaveLanding = function(){
		if($scope.email && $scope.apiToken){
			var user = JSON.parse($window.localStorage.getItem("user"));
			$http.get(apiUrl + "/api/v1?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error(function(err){
				$state.go("app.home", {}, { reload: true, }); 
			});
			/*if(user && user.sport_id){ $state.go("app.matchs", {}, { reload: true, }); }
			else{ $state.go("app.home", {}, { reload: true, }); }*/
		}else{ $state.go("showAuth", {}, { reload: true, }); };
	};
	$scope.view = 2;
	$scope.tennisSplash = function(){
		$scope.view = 5;
		$timeout(function(){ $scope.leaveLanding(); }, 700);
	};
	$scope.padelSplash = function(){
		$scope.view = 4;
		$timeout(function(){ $scope.tennisSplash(); }, 700);
	};
	$scope.squashSplash = function(){
		$scope.view = 3;
		$timeout(function(){ $scope.padelSplash(); }, 700);
	};
	$timeout(function(){ $scope.squashSplash(); }, 1000);
})
//=== Show Auth Controller ===//
.controller("ShowAuth", function($rootScope, $window, $state, $scope, $q, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $location, LoaderService, apiUrl){
	$scope.$state = $state;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	$scope.gotoprofile = function(){ $state.go("app.profile", {}, { reload: true, }); };
	$scope.Register = function(){ $state.go("register", {}, { reload: true, }); };
	$scope.Login = function(){ $state.go("myloginpa", {}, { reload: true, }); };
})
//=== Register Controller ===//
.controller("Register", function($rootScope, $window, $state, $scope, $cordovaGoogleAnalytics, $q, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, $cordovaKeyboard, apiUrl, ionicDatePicker, facebookApi, googleApi, $cordovaDevice, $cordovaGeolocation, LoaderService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	$scope.gotoprofile = function(){ $state.go("app.profile", {}, { reload: true, }); };
	if(window.cordova){ $scope.deviceId = $cordovaDevice.getUUID(); }
	else{ $scope.deviceId = moment().format("YYYYMMDDTHHmmssS"); }
	$scope.signupData = { deviceId: $scope.deviceId, };
	if(window.analytics){ $cordovaGoogleAnalytics.trackView('SignUp'); };
	$scope.genders = [{ key: "male", value: "Homme", }, { key: "female", value: "Femme", }];
	$scope.getOption = function(option){ return option.key; };
	$scope.success = function(res){
		if(res.status){
			res.data.api_token = res.api_token;
			$rootScope.currentUser = res.data;
			$window.localStorage.setItem('login_email', $scope.signupData.email);
			$window.localStorage.setItem('login_password', $scope.signupData.password);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('SignUp', 'User SignUp', "Email", $rootScope.currentUser.email); };
			$state.go("app.home", {}, { reload: true, });
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		LoaderService.Hide();
		$ionicPopup.alert({ title: error, });
	};
	$scope.Register = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/register", data).success($scope.success).error($scope.error);
			}catch(err){
				LoaderService.Hide();
				$ionicPopup.alert({ title: err.error, template: err, });
			}
		};
	};
	$scope.SocialRegister = function(userData){
		LoaderService.Show();
		$http.defaults.headers.post["Content-Type"] = "application/json";
		$http.post(apiUrl + "/api/v1/auth/social", userData).success(function(res){
			LoaderService.Hide();
			if(res.status){
				res.data.api_token = res.api_token;
				$rootScope.currentUser = res.data;
				$window.localStorage.setItem('email', res.data.email);
				$window.localStorage.setItem('api_token', res.api_token);
				$window.localStorage.setItem('user', JSON.stringify(res.data));
				$window.sessionStorage.currentEmail = res.data.email; // Access Token details
				$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
				$window.sessionStorage.user_id = res.data.id;
				if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('SignUp', 'User SignUp', "Email", $rootScope.currentUser.email); };
				$state.go("app.home", {}, { reload: true, });
			}else{ $ionicPopup.alert({ title: res.error, }); };
		}).error($scope.error);
	};
	$scope.SocialError = function(error){
		LoaderService.Hide();
		$ionicPopup.alert({ title: error, });
	};
	$scope.FBLogin = function(){
		$cordovaOauth.facebook(facebookApi, ["public_profile", "email"]).then(function(result){
			LoaderService.Show();
			$http.get("https://graph.facebook.com/v2.2/me", { params: { access_token: result.access_token, fields: "name,email,gender,location,picture", format: "json" } }).then(function(data){
				var profileInfo = data.data, userData = {
					email: profileInfo.email,
					password: profileInfo.id,
					age: 1, name: profileInfo.name,
					gender: profileInfo.gender ? profileInfo.gender : 'male',
					socialId: profileInfo.id, social: 1,
					deviceId: $scope.deviceId,
				};
				$scope.SocialRegister(userData);
			}, $scope.SocialError);
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};
	$scope.GoogleLogin = function(){
		$cordovaOauth.google(googleApi, ["https://www.googleapis.com/auth/userinfo.profile", "https://www.googleapis.com/auth/userinfo.email"]).then(function(result){
			try{
				LoaderService.Show();
				$http({ url: 'https://www.googleapis.com/oauth2/v3/userinfo', method: 'GET', params: { access_token: result.access_token, }, }).then(function(data){
					var profileInfo = data.data, userData = {
						email: profileInfo.email,
						password: profileInfo.sub,
						age: 1, name: profileInfo.name,
						gender: profileInfo.gender ? profileInfo.gender : 'male',
						socialId: profileInfo.sub, social: 0,
						deviceId: $scope.deviceId,
					};
					$scope.SocialRegister(userData);
				}, $scope.SocialError);
			}catch(err){
				LoaderService.Hide();
				$ionicPopup.alert({ title: err.error, template: err, });
			}
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};
	$scope.inputDate = new Date();
	$scope.openDatePicker = function(){
		ionicDatePicker.openDatePicker({
			callback: function(val){
				$scope.inputDate = new Date(val);
				$scope.signupData.birthdate = moment(val).format("DD/MM/YYYY");
			},
			from: moment().subtract("110", "years"),
			to: new Date(),
			inputDate: $scope.inputDate,
			mondayFirst: false,
			closeOnSelect: true,
			dateFormat: 'dd/MM/yyyy',
			templateType: 'popup',
			titleLabel: 'Sélectionnez une date',
			setLabel: 'Définir',
			todayLabel: 'Aujourd\'hui',
			closeLabel: 'Fermer',
			weeksList: [ "D","L","M","M","J","V","S" ],
			monthsList: [ "janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc." ],
		});
	};
})
/*//=== Login Controller ===//
.controller("Login", function($rootScope, $window, $state, $scope, $cordovaGoogleAnalytics, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi, $cordovaDevice){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	var strEmail = $window.localStorage.getItem('login_email');
	$scope.loginData = (strEmail != null && strEmail != 'null') ? { email: strEmail, password: $window.localStorage.getItem('login_password'), } : {};
	if(window.cordova){ $scope.deviceId = $cordovaDevice.getUUID(); }
	else{ $scope.deviceId = moment().format("YYYYMMDDTHHmmssS"); }
	if(window.analytics){ $cordovaGoogleAnalytics.trackView('Login'); };
	$scope.success = function(res){
		if(res.status){
			res.data.api_token = res.api_token;
			$rootScope.currentUser = res.data;
			$window.localStorage.setItem('login_email', $scope.loginData.email);
			$window.localStorage.setItem('login_password', $scope.loginData.password);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('Login', 'User Login', "Email", $rootScope.currentUser.email); };
			$state.go("app.home", {}, { reload: true, });
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
	$scope.Login = function(form, data){
		if(form.$valid){
			$scope.loginData.email = data.email;
			$scope.loginData.password = data.password;
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/login", {
					email: $scope.loginData.email,
					password: $scope.loginData.password,
					deviceId: $scope.deviceId,
				}).success($scope.success).error($scope.error);
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
	$scope.SocialLogin = function(userData){
		LoaderService.Show();
		$http.defaults.headers.post["Content-Type"] = "application/json";
		$http.post(apiUrl + "/api/v1/auth/social", userData).success(function(res){
			LoaderService.Hide();
			if(res.status){
				res.data.api_token = res.api_token;
				$rootScope.currentUser = res.data;	
				$window.localStorage.setItem('email', res.data.email);
				$window.localStorage.setItem('api_token', res.api_token);
				$window.localStorage.setItem('user', JSON.stringify(res.data));
				$window.sessionStorage.currentEmail = res.data.email; // Access Token details
				$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
				$window.sessionStorage.user_id = res.data.id;
				if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('Login', 'User Login', "Email", $rootScope.currentUser.email); };
				$state.go("app.home", {}, { reload: true, });
			}else{ $ionicPopup.alert({ title: res.error, }); };
		}).error($scope.error);
	};
	$scope.SocialError = function(error){
		LoaderService.Hide();
		$ionicPopup.alert({ title: error, });
	};
	$scope.FBLogin = function(){
		$cordovaOauth.facebook(facebookApi, ["public_profile", "email"]).then(function(result){
			LoaderService.Show();
			$http.get("https://graph.facebook.com/v2.2/me", { params: { access_token: result.access_token, fields: "name,email,gender,location,picture", format: "json" } }).then(function(data){
				var profileInfo = data.data, userData = {
					email: profileInfo.email,
					password: profileInfo.id,
					age: 1, name: profileInfo.name,
					gender: profileInfo.gender ? profileInfo.gender : 'male',
					socialId: profileInfo.id, social: 1,
					deviceId: $scope.deviceId,
				};
				$scope.SocialLogin(userData);
			}, $scope.SocialError);
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};
	$scope.GoogleLogin = function(){
		$cordovaOauth.google(googleApi, ["https://www.googleapis.com/auth/userinfo.profile", "https://www.googleapis.com/auth/userinfo.email"]).then(function(result){
			try{
				LoaderService.Show();
				$http({ url: 'https://www.googleapis.com/oauth2/v3/userinfo', method: 'GET', params: { access_token: result.access_token, }, }).then(function(data){
					var profileInfo = data.data, userData = {
						email: profileInfo.email,
						password: profileInfo.sub,
						age: 1, name: profileInfo.name,
						gender: profileInfo.gender ? profileInfo.gender : 'male',
						socialId: profileInfo.sub, social: 0,
						deviceId: $scope.deviceId,
					};
					$scope.SocialLogin(userData);
				}, $scope.SocialError);
			}catch(err){
				LoaderService.Hide();
				$ionicPopup.alert({ title: err.error, template: err, });
			}
		}, function(error){ $ionicPopup.alert({ title: error, }); });
	};
})*/











//=== Forgot Controller ===//
.controller("Forgot", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	if($scope.email && $scope.apiToken){ $scope.gotohome(); };
	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
	$scope.forgotData = {};
	$scope.Forgot = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/forgot", data).success(function(res){
					LoaderService.Hide();
					if(res.status){
						$ionicPopup.alert({ title: res.message, });
						$state.go('reset', { email: data.email, }, { reload: true, });
					}else{ $ionicPopup.alert({ title: res.error, }); };
				}).error($scope.error);
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
})
//=== ResetPwd Controller ===//
.controller("ResetPwd", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi){
	$scope.$state = $state;
	$scope.apiEmail = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	if($scope.apiEmail && $scope.apiToken){ $state.go("app.home", {}, { reload: true, }); };
	if(!$stateParams.email){ $state.go("forgot", {}, { reload: true, }); }
	$scope.resetData = { email: $stateParams.email, };
	$scope.error = function(err){
		if(err.expired){ $state.go("forgot", {}, { reload: true, }); }
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
	$scope.Reset = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";
				$http.post(apiUrl + "/api/v1/auth/verify-token", data).success(function(res){
					LoaderService.Hide();
					if(res.status){
						$ionicPopup.alert({ title: res.message, });
						$state.go('myloginpa', {}, { reload: true, });
					}else{ $ionicPopup.alert({ title: res.error, }); };
				}).error($scope.error);
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
})
//=== ProposCtrl Controller ===//
.controller("ProposCtrl", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaContacts, $cordovaGeolocation, apiUrl){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.delete_cookie = function(name){ document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;'; };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.Logout = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/logout?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			LoaderService.Hide();
			if(res.status){ $scope.deleteSession(); }
			else{ $ionicPopup.alert({ title: res.error, }); }
		}).error(function(err, status){
			if(status == 401){ $scope.deleteSession(); }
			else{
				var error = err.error;
				if(err.validation){
					error = "";
					angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
				}
				$ionicPopup.alert({ title: error, });
				LoaderService.Hide();
			}
		});
	};
	$scope.Profile = function(){ $state.go('app.profile', {}, { reload: true, }); };
	$scope.Propos = function(){ $state.go('propos.home', {}, { reload: true, }); };
	$scope.getAllContacts = function(){
		var opts = { filter: '', multiple: true, fields: ['displayName', 'name'], };
		if(ionic.Platform.isAndroid()){ opts.hasPhoneNumber = true; /* hasPhoneNumber only works for android. */ };
		try{
			/*$cordovaContacts.find(opts).then(function(allContacts){ //omitting parameter to .find() causes all contacts to be returned
				console.log(JSON.stringify(allContacts));
			});*/
			$cordovaContacts.pickContact().then(function(contactPicked){
				/*alert(contactPicked.phoneNumbers.length);
				alert(contactPicked.emails.length);
				alert(contactPicked.displayName);*/
				$ionicPopup.alert({ template: "phoneNumbers: " + contactPicked.phoneNumbers.length + "<br>displayName: "  + contactPicked.displayName, });
			});
		}catch(err){ $ionicPopup.alert({ title: err.error, template: err, }); }
	};
	$scope.getLocation = function(){
		LoaderService.Show();
		$cordovaGeolocation.getCurrentPosition({ enableHighAccuracy: false, timeout: 10000, maximumAge: 0, }).then(function(position){
			alert(
				'Latitude: ' + position.coords.latitude + '\n' +
				'Longitude: ' + position.coords.longitude + '\n' +
				'Altitude: ' + position.coords.altitude + '\n' +
				'Accuracy: ' + position.coords.accuracy + '\n' +
				'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
				'Heading: ' + position.coords.heading + '\n' +
				'Speed: ' + position.coords.speed + '\n' +
				'Timestamp: ' + position.timestamp + '\n'
			);
			LoaderService.Hide();
		}, function(error){
			alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
			LoaderService.Hide();
		});
	};
})
//=== Propos Home Controller ===//
.controller("Propos", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.error = function(err){
		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();
	};
})
//=== AppCtrl Controller ===//
.controller("AppCtrl", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $interval, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaContacts, $cordovaLocalNotification, $cordovaGeolocation, apiUrl, LocationService, PubNubService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.delete_cookie = function(name){ document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;'; };
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url.replace("/image/", "/image/thumbnail/"); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.Logout = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/logout?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			LoaderService.Hide();
			if(res.status){
				$interval.cancel(promise1);
				$interval.cancel(promise2);
				$scope.deleteSession();
			}else{ $ionicPopup.alert({ title: res.error, }); }
		}).error(function(err, status){
			if(status == 401){ $scope.deleteSession(); }
			else{
				var error = err.error;
				if(err.validation){
					error = "";
					angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
				}
				$ionicPopup.alert({ title: error, });
				LoaderService.Hide();
			}
		});
	};
	$scope.goTo = function(state){
		if($state.current.name != state){
			LoaderService.Show();
			$state.go(state, {}, { reload: true, });
		}
	};
	$scope.$on("updateAuthUser", function(event, user, sports){
		$scope.authuser = user;
		$scope.sports = sports;
		if(!$scope.$$phase){ $scope.$apply(); }
	});
	$scope.getAllContacts = function(){
		var opts = { filter: '', multiple: true, fields: ['displayName', 'name'], };
		if(ionic.Platform.isAndroid()){ opts.hasPhoneNumber = true; /* hasPhoneNumber only works for android. */ };
		try{
			$cordovaContacts.pickContact().then(function(contactPicked){
				/*alert(contactPicked.phoneNumbers.length);alert(contactPicked.emails.length);alert(contactPicked.displayName);*/
				$ionicPopup.alert({ template: "phoneNumbers: " + contactPicked.phoneNumbers.length + "<br>displayName: "  + contactPicked.displayName, });
			});
		}catch(err){ $ionicPopup.alert({ title: err.error, template: err, }); }
	};
	$rootScope.$on('$cordovaLocalNotification:click', function(event, notification, state){
		var value = JSON.parse(notification.data);
		if(value.inviteNotification && value.goToMatch){
			var match = value.match;
			if(match){ $state.go("app.matchView", { matchId: match.id, }, { reload: true, }); }
		};
		if(value.messageNotification && value.goToMatchChat){
			var message = value.message;
			if(message){ $state.go("app.matchChat", { matchId: message.match, }, { reload: true, }); }
		};
		if(value.messageNotification && value.goToFriendChat){
			var message = value.message;
			if(message){ $state.go("app.chatFriend", { friendId: message.friend, }, { reload: true, }); }
		};
	});
	PubNubService.addListener({
		status: function(statusEvent){
			if(statusEvent.category === "PNUnknownCategory"){
				var newState = { new: 'error', };
				PubNubService.setState({ state: newState, }, function(status){
					console.log(statusEvent.errorData.message)
				});
			}
		},
		message: function(res){
			var isNotify = true, states = ['app.matchChat', 'app.chat', 'app.chatFriend', ];
			for(var i = 0; i < states.length; i++){ if($state.current.name == states[i]){ isNotify = false; } };
			if(isNotify && $window.cordova && $window.cordova.plugins){
				if(res.message.isMatchChat && res.message.user != $scope.authuser.id){
					$cordovaLocalNotification.schedule({
						id: res.message.match + res.message.user + $scope.authuser.id,
						title: 'New Message From - ' + res.message.userName,
						text: res.message.message,
						data: {
							message: res.message,
							messageNotification: true,
							goToMatchChat: true,
						},
					}).then(function(result){});
				}
				if(res.message.isFriendChat && res.message.senderId != $scope.authuser.id){
					$cordovaLocalNotification.schedule({
						id: res.message.senderId + res.message.friend + res.message.receiverId,
						title: 'New Message From - ' + res.message.senderName,
						text: res.message.message,
						data: {
							message: res.message,
							messageNotification: true,
							goToFriendChat: true,
						},
					}).then(function(result){});
				}
			}
		},
		presence: function(m){ console.log(m); },
	});
	$scope.badgeCount = 0;
	$scope.$on("updateBadgeCount", function(event, notifications){
		$scope.notifications = notifications;
		$scope.badgeCount = $scope.notifications.length;
		if(!$scope.$$phase){ $scope.$apply(); }
	});
	$scope.watchNotification = function(){
		$http.get(apiUrl + "/api/v1/notification?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			$scope.authuser = res.user;
			$scope.notifications = res.notifications;
			$scope.badgeCount = $scope.notifications.length;
		}).error(function(){
			$interval.cancel(promise1);
			$interval.cancel(promise2);
		});

	};
	$scope.watchLocation = function(){
		/*$rootScope.watch = $cordovaGeolocation.watchPosition({ enableHighAccuracy: false, timeout: 10000, maximumAge: 300000, });
		$rootScope.watch.then(null, function(error){}, function(position){
			LocationService.postLocation(apiUrl, $scope.apiToken, { lat: position.coords.latitude, long: position.coords.longitude, });
		});*/
		$cordovaGeolocation.getCurrentPosition({ enableHighAccuracy: false, timeout: 10000, maximumAge: 0, }).then(function(position){
			LocationService.postLocation(apiUrl, $scope.apiToken, { lat: position.coords.latitude, long: position.coords.longitude, }).error(function(){
				$interval.cancel(promise1);
				$interval.cancel(promise2);
			});
		}, function(error){});
	};
	$scope.watchNotification();
	$scope.watchLocation();
	var promise1 = $interval($scope.watchNotification, 60000);
	var promise2 = $interval($scope.watchLocation, 600000);
})
//=== Notification Controller ===//
.controller("Notification", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, apiUrl, $cordovaCamera, $ionicModal, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.success = function(res){
		$scope.currentUser = $rootScope.currentUser = res.user;
		$scope.inputDate = new Date($scope.currentUser.birthdate);
		$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
		$scope.currentUser.sport_id = String($scope.currentUser.sport_id);
		$window.localStorage.setItem('email', res.user.email);
		$window.localStorage.setItem('api_token', res.user.api_token);
		$window.localStorage.setItem('user', JSON.stringify(res.user));
		$window.sessionStorage.currentEmail = res.user.email; // Access Token details
		$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
		$window.sessionStorage.user_id = res.user.id;
		$scope.authuser = $scope.currentUser;
		$scope.notifications = res.notifications;
		$scope.notifications.forEach(function(x){ x.created_at = new Date(x.created_at); });
		$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		$rootScope.$broadcast("updateBadgeCount", $scope.notifications);
		if(!$scope.$$phase){ $scope.$apply(); }
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.goToNotification = function(notification){
		LoaderService.Show();
		$http.post(apiUrl + "/api/v1/notification/read/" + notification.id + "?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
			$scope.success(res);
			if(notification.object == "MatchInvite"){
				$state.go("app.matchView", { matchId: notification.object_id, }, { reload: true, });
			}
		}).error($scope.error);
	};
	$scope.getData = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/notification?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
	};
	$scope.getData();
})
//=== Profile Controller ===//
.controller("Profile", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, apiUrl, $cordovaCamera, $ionicModal, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.posts = [{ key: "attacker", value: "Attaquant", }, { key: "middle", value: "Milieu", }, { key: "defender", value: "Défenseur", }, { key: "guardian", value: "Gardien", }];
	$scope.post = "Select Poste";
	$scope.genders = [{ key: "male", value: "Homme", }, { key: "female", value: "Femme", }];
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.success = function(res){
		if(res.status){
			$rootScope.currentUser = res.data;
			$scope.inputDate = new Date($scope.currentUser.birthdate);
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$scope.currentUser.sport_id = String($scope.currentUser.sport_id);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.data.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.data.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			$scope.authuser = $scope.currentUser;
			$scope.sports = res.sports;
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser, $scope.sports);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.$watch(function(){
				return $scope.currentUser.post;
			}, function(){
				var postOptions = { "attacker": "Attaquant", "middle": "Milieu", "defender": "Défenseur", "guardian": "Gardien", };
				$scope.post = postOptions[$scope.currentUser.post];
			}, true);
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.formatDate = function(date){
		var dateOut = new Date(date);
		return dateOut;
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
	};
	$scope.openDatePicker = function(){
		ionicDatePicker.openDatePicker({
			callback: function(val){
				$scope.inputDate = new Date(val);
				$scope.currentUser.birthdate = moment(val).format("DD/MM/YYYY");
			},
			from: moment().subtract("110", "years"),
			to: new Date(),
			inputDate: $scope.inputDate,
			mondayFirst: false,
			closeOnSelect: true,
			dateFormat: 'dd/MM/yyyy',
			templateType: 'popup',
			titleLabel: 'Sélectionnez une date',
			setLabel: 'Définir',
			todayLabel: 'Aujourd\'hui',
			closeLabel: 'Fermer',
			weeksList: [ "D","L","M","M","J","V","S" ],
			monthsList: [ "janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc." ],
		});
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url.replace('/image/', '/image/thumbnail/'); };
	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 30, allowEdit: false,
			destinationType: Camera.DestinationType.DATA_URL,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};
		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			$scope.currentUser.imageData = "data:image/jpeg;base64," + imageData;
			$scope.currentUser.hasImage = true;
			if(!$scope.$$phase){ $scope.$apply(); }
			LoaderService.Hide();
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});
	};
	$scope.Update = function(form, data){
		if(form.$valid){
			try{
				LoaderService.Show();
				if($scope.image && $scope.fileName){
					var options = { fileKey: "photo", fileName: $scope.fileName, chunkedMode: false, mimeType: "image/png", params: data, };
					var Url = apiUrl + "/api/v1/profile?api_token=" + $scope.apiToken;
					$cordovaFileTransfer.upload(Url, $scope.image, options).then(function(res){
						$state.go("app.matchs", {}, { reload: true, });
					}, function(res){
						var status = res.http_status, err = JSON.parse(res.body);
						$scope.error(err, status);
					}, function(progress){});
				}else{
					$http.post(apiUrl + "/api/v1/profile?api_token=" + $scope.apiToken, data, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
						LoaderService.Hide();
						if(res.status){
							res.data.birthdate = moment(res.data.birthdate).format("DD/MM/YYYY");
							$rootScope.$broadcast("updateAuthUser", res.data);
							$state.go("app.matchs", {}, { reload: true, });
						}else{ $ionicPopup.alert({ title: res.error, }); };
					}).error($scope.error);
				}
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 50, allowEdit: false,
			destinationType: Camera.DestinationType.FILE_URI,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};
		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			window.resolveLocalFileSystemURI(imageData, function(fileEntry){
				fileEntry.file(function(filee){
					$scope.image = imageData;
					$scope.fileName = filee.name;
					if(!$scope.$$phase){ $scope.$apply(); }
					LoaderService.Hide();
				}, function(error){
					LoaderService.Hide();
					$ionicPopup.alert({ title: error, });
				});
			},  function(error){
				LoaderService.Hide();
				$ionicPopup.alert({ title: error, });
			});
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});
	};
	$scope.getOption = function(option){ return option.key; };
	$scope.getData();
})
//=== Home Controller ===//
.controller("Home", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaGeolocation, $cordovaLocalNotification, apiUrl, PubNubService, resource){
	$ionicHistory.clearHistory();
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.success = function(res){
		if(res.status){
			$scope.authuser = $rootScope.currentUser = res.data;
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.data.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.data.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;
			$scope.sports = res.sports;
			$scope.cssStyle = { height: (100 / $scope.sports.length) + "%", };
			$scope.invites = res.invites;
			if($window.cordova && $window.cordova.plugins && $scope.invites){
				angular.forEach($scope.invites, function(value, key){
					$cordovaLocalNotification.schedule({
						id: value.id + value.sport.id + value.user.id + $scope.authuser.id,
						title: value.user.name + ' - Inviter ' + value.name,
						text: value.user.name + ' - Inviter ' + value.name + ' to play ' + value.sport.name,
						data: {
							message: value,
							inviteNotification: true,
							goToMatch: true,
						},
					}).then(function(result){});
				});
			}
			$scope.channels = res.channels;
			angular.forEach($scope.channels, function(channel, key){ PubNubService.subscribe({ channels: [channel], withPresence: true, }); });
			$rootScope.$broadcast("updateAuthUser", $scope.authuser, $scope.sports);
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.backgroundImage = function(sport){
		// var url = apiUrl + '/' + sport.image.replace('/image/', '/image/thumbnail/');
		var url = apiUrl + '/' + sport.image;
		return { 'background-image': "url('" + url + "')", };
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			LoaderService.Hide();
		}
	};
	$scope.goToSport = function(sportId){
		if(sportId){
			$http.post(apiUrl + "/api/v1/change-sport?api_token=" + $scope.apiToken, { "sport_id": sportId, }, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				if(res.status){ $state.go("app.rejoin", {}, { reload: true, }); }
				else{
					LoaderService.Hide();
					$ionicPopup.alert({ title: res.error, });
				};
			}).error($scope.error);
		}
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url.replace('/image/', '/image/thumbnail/'); };
	if($scope.email || $scope.apiToken){
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	}else{ $state.go("myloginpa", {}, { reload: true, }); };
})
//=== Create Match Controller ===//
.controller("CreateMatch", function($rootScope, $window, $cordovaGoogleAnalytics, $state, $scope, $q, LoaderService, $ionicModal, $cordovaContacts, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, $cordovaCamera, $ionicScrollDelegate, $ionicActionSheet, $cordovaFileTransfer, $cordovaDatePicker, $cordovaFacebook, $cordovaSocialSharing, facebookApi, resource, fbContacts){
	// tu as choisi de jouer dans un centre non partenaire :n'oublie pas d'appeler le club pour réserver ton terrain.
	LoaderService.Show();
	$scope.scheme = false;
	$scope.$state = $state;
	if(typeof appAvailability !== 'undefined'){
		var scheme = 'com.whatsapp';
		if(ionic.Platform.isIOS()){ scheme = 'whatsapp://'; };
		appAvailability.check(scheme, function(){
			$scope.scheme = true;
		}, function(){
			$scope.scheme = false;
		});
	};
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchData = { visibility: 'public', };
	$scope.pageTitle = "Créer un match";
	$scope.pageView = 1;
	$scope.teamTitle = "Défier une équipe";
	$scope.playerTitle = "Nombre de joueurs 10";
	if(window.analytics){ $cordovaGoogleAnalytics.trackView('Create Match'); };
	$scope.$watch(function(){ return $scope.matchData.players; }, function(){ if($scope.matchData.players){ $scope.playerTitle = $scope.matchData.players; } }, true);
	$scope.$watch(function(){ return $scope.matchData.team_id; }, function(){
		angular.forEach($scope.teams, function(value, key){ if($scope.matchData.team_id == value.id){ $scope.teamTitle = value.name; }; });
	}, true);
	$scope.isSimpleDouble = false;
	$scope.numbers = [];
	for(var i = 1; i <= 10; i++){ $scope.numbers.push(i); };
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("login", {}, { reload: true, });
	};
	$scope.inputDate = new Date();
	// $scope.inputTime = new Date();
	$scope.inputTime = (((new Date()).getHours() * 60 * 60) + ((new Date()).getMinutes() * 60));
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$scope.users = res.users;
			$scope.venues = res.venues;
			$scope.teams = res.teams;
			if($scope.isSimpleDouble == true){
				$scope.matchData.type = "simple";
				$scope.matchData.players = 2;
			};
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.allContacts = [];
	$scope.fbContacts = [];
	$scope.getDetails = function(){
		LoaderService.Show();
		if(fbContacts.success){ $scope.fbContacts = fbContacts.data; };
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	};		
	$scope.getData = function(){
		try{
			if(window.cordova && window.cordova.plugins){
				$cordovaContacts.find({ filter: '', multiple: true, fields: ['displayName', 'name'], }).then(function(allContacts){
					angular.forEach(allContacts, function(contact, key){
						if(angular.isArray(contact.emails) && contact.emails.length > 0){
							angular.forEach(contact.emails, function(Econtact, Ekey){
								$scope.allContacts.push({ isContact: true, name: contact.displayName, email: Econtact.value, });
							});
						}
					});
					$scope.getDetails();
				}, function(err){
					$ionicPopup.alert({ title: err.error, template: err, });
					$state.go("app.home", {}, { reload: true, });
				});
			}else{ $scope.getDetails(); }
		}catch(err){ $ionicPopup.alert({ title: err.error, template: err, }); }
	};
	$scope.openDatePicker = function(){
		ionicDatePicker.openDatePicker({
			callback: function(val){
				$scope.inputDate = new Date(val);
				var options = {
					callback: function(valTime){
						if(typeof (valTime) === 'undefined'){ $scope.openDatePicker(); }
						else{
							$scope.inputTime = valTime;
							$scope.matchData.datetime = moment(val).format("DD/MM/YYYY") + " " + moment.utc(valTime * 1000).format("HH:mm");
						}
					},
					inputTime: $scope.inputTime,
					format: 24,
					step: 10,
					setLabel: 'Définir',
					closeLabel: 'Fermer',
				};
				ionicTimePicker.openTimePicker(options);
			},
			from: moment().add(1, "day"),
			to: moment().add(10, "years"),
			inputDate: $scope.inputDate,
			mondayFirst: false,
			closeOnSelect: true,
			dateFormat: 'dd/MM/yyyy',
			templateType: 'popup',
			titleLabel: 'Sélectionnez une date',
			setLabel: 'Définir',
			todayLabel: 'Aujourd\'hui',
			closeLabel: 'Fermer',
			weeksList: [ "D","L","M","M","J","V","S" ],
			monthsList: [ "janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc." ],
		});
		/*var defaultDate = (ionic.Platform.isIOS() ? new Date() : new Date().getTime());
		$cordovaDatePicker.show({
			date: $scope.inputDate,
			mode: 'date',
			minDate: defaultDate,
			allowOldDates: false,
			allowFutureDates: true,
			doneButtonLabel: 'Définir',
			doneButtonColor: '#01a3e3',
			cancelButtonLabel: 'Fermer',
			cancelButtonColor: '#01a3e3',
			cancelText: 'Fermer',
			okText: 'Définir',
		}).then(function(date){
			$scope.inputDate = new Date(date);
			$cordovaDatePicker.show({
				date: $scope.inputTime,
				mode: 'time',
				allowOldDates: false,
				allowFutureDates: true,
				doneButtonLabel: 'Définir',
				doneButtonColor: '#01a3e3',
				cancelButtonLabel: 'Fermer',
				cancelButtonColor: '#01a3e3',
				cancelText: 'Fermer',
				okText: 'Définir',
			}).then(function(val){
				$scope.inputTime = val;
				$scope.matchData.datetime = moment(date).format("DD/MM/YYYY") + " " + moment(val).format("HH:mm");
			});
		});*/
	};
	$scope.changeVisibility = function(visibility){ $scope.matchData.visibility = visibility; };
	$scope.changeType = function(type){
		$scope.matchData.players = 4;
		if(type == 'simple'){ $scope.matchData.players = 2; }
		$scope.matchData.type = type;
	};
	$scope.fbShare = function(matchData){
		if($scope.fbInvities.length > 0){
			/*facebookConnectPlugin.appInvite({
				appLinkURL: https://fb.me/746928768795507
				url: "http://example.com",
				picture: "http://example.com/image.png"
			}, function(obj){
				if(obj){
					if(obj.completionGesture == "cancel"){
						// user canceled, bad guy
					}else{
						// user really invited someone :) 
					}
				}else{
					// user just pressed done, bad guy 
				}
			}, function(err){ alert(JSON.stringify(err)); });*/
			facebookConnectPlugin.showDialog({
				method: "share",
				picture: 'https://scontent.fmaa2-1.fna.fbcdn.net/t39.2081-0/p168x128/15945747_744449809043403_2404151383235231744_n.png',
				name: matchData.match.name + ' - DoInSport',
				message: matchData.match.name,
				description: matchData.shareFBMessage,
			}, function(res){
				$state.go("app.matchs", {}, { reload: true, }); 
			}, function(err){
				$ionicPopup.alert({ title: err.errorMessage, });
				$state.go("app.matchs", {}, { reload: true, }); 
			});
			/*$cordovaFacebook.getAccessToken().then(function(token){
				openFB.init({ appId: facebookApi, accessToken: token, });
				openFB.api({
					method: 'POST',
					path: '/me/feed',
					params: {
						message: 'Testing Facebook APIs',
						// tags: 
					},
					success: function(){
						alert('the item was posted on Facebook');
					},
					error: function(err){
						alert(JSON.stringify(err));
					},
				});
			}, function(err){
				alert(JSON.stringify(err));
			});*/
		}else{ $state.go("app.matchs", {}, { reload: true, }); }
	};
	$scope.Create = function(form, data){
		if(!$scope.matchData.image){ $ionicPopup.alert({ title: "Sélectionnez d'abord l'image!", }); }
		else if(!$scope.matchData.venue_id){ $ionicPopup.alert({ title: "Sélectionnez d'abord Votre Centre!", }); }
		else if(form.$valid && data.players){
			try{
				var parameters = { name: data.name, visibility: data.visibility, datetime: data.datetime,
					venue_id: data.venue_id, team_id: data.team_id, players: data.players,
					level: data.level, type: data.type,
				};
				if($scope.matchData.invities.length > 0){ parameters.invities = data.invities; }
				LoaderService.Show();
				var options = {
					fileKey: "image",
					fileName: $scope.fileName,
					chunkedMode: false,
					mimeType: "image/png",
					params: parameters,
				};
				var Url = apiUrl + "/api/v1/match/create?api_token=" + $scope.apiToken;
				$cordovaFileTransfer.upload(Url, $scope.matchData.image, options).then(function(res){
					if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('MatchCreation', 'Match Creation', "Name", data.name); };
					var matchData = JSON.parse(res.response);
					// $state.go("app.matchs", {}, { reload: true, });
					$scope.fbShare(matchData);
				}, function(res){
					var status = res.http_status;
					if(status == 401){ $scope.deleteSession(); }
					else{
						var err = JSON.parse(res.body);
						if(err.validation){
							var error = "";
							angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
							$ionicPopup.alert({ title: error, });
						}else{
							var error = err.error;
							$ionicPopup.alert({ title: error, });
						}
						if(err.redirect){
							$backView = $ionicHistory.backView();
							if($backView){ $backView.go(); }
							else{ $scope.gotohome(); }
						}
						LoaderService.Hide();
					}
				}, function(progress){});
			}catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};
	$scope.matchData.invities = [];
	$scope.matchData.level = 3;
	$scope.ratingsObject = {
		iconOn: 'ion-ios-star',
		iconOff: 'ion-ios-star-outline',
		iconOnColor: 'rgb(255, 215, 0)',
		iconOffColor:  'rgb(255, 215, 0)',
		rating: $scope.matchData.level,
		minRating: 1,
		callback: function(level, index){
			$scope.matchData.level = level;
			if(!$scope.$$phase){ $scope.$apply(); }
		}
	};
	$scope.changeInvite = function(invite, value){
		var isInvited = false;
		for(var i = 0; i < $scope.matchData.invities.length; i++){
			if(String($scope.matchData.invities[i]) == String(value)){
				invite.checked = false;
				$scope.matchData.invities.splice(i, 1);
				isInvited = true;
				break;
			}
		};
		if(!isInvited && $scope.matchData.invities.length < $scope.matchData.players - 1){
			invite.checked = true;
			$scope.matchData.invities.push(value);
		}
	};
	$scope.fbInvities = [];
	$scope.changeFbInvite = function(invite, value){
		var isInvited = false;
		for(var i = 0; i < $scope.fbInvities.length; i++){
			if(String($scope.fbInvities[i]) == String(value)){
				invite.checked = false;
				$scope.fbInvities.splice(i, 1);
				isInvited = true;
				break;
			}
		};
		if(!isInvited){
			invite.checked = true;
			$scope.fbInvities.push(value);
		}
	};
	$scope.getOption = function(option){ return option.id; };
	$scope.fileName = "Importer la photo";
	$scope.openPhotoLibrary = function(){
		var options = {
			quality: 50, allowEdit: false,
			destinationType: Camera.DestinationType.FILE_URI,
			sourceType : Camera.PictureSourceType.PHOTOLIBRARY,
			encodingType: Camera.EncodingType.JPEG,
			popoverOptions: CameraPopoverOptions,
			saveToPhotoAlbum: false, correctOrientation: true,
		};
		LoaderService.Show();
		$cordovaCamera.getPicture(options).then(function(imageData){
			window.resolveLocalFileSystemURI(imageData, function(fileEntry){
				fileEntry.file(function(filee){
					$scope.matchData.image = imageData;
					$scope.fileName = filee.name;
					if(!$scope.$$phase){ $scope.$apply(); }
					LoaderService.Hide();
				}, function(error){
					LoaderService.Hide();
					$ionicPopup.alert({ title: error, });
				});
			},  function(error){
				LoaderService.Hide();
				$ionicPopup.alert({ title: error, });
			});
		}, function(error){
			LoaderService.Hide();
			$ionicPopup.alert({ title: error, });
		});
	};
	$scope.ShowInvite = function(form, data){
		if(form.$valid && data.players){
			$scope.showContacts = 1;
			LoaderService.Show();
			$scope.pageTitle = "Inviter des joueurs";
			$scope.pageView = 2;
			$ionicScrollDelegate.scrollTop();
			LoaderService.Hide();
		}else{ $ionicPopup.alert({ title: "Veuillez entrer les détails du match en premier!", }); }
	};
	$scope.changeView = function(num, data){
		if($scope.pageView == 2){
			if(num == 3){
				if(!$scope.matchData.image){ $ionicPopup.alert({ title: "Sélectionnez d'abord l'image!", }); }
				else if(!$scope.matchData.venue_id){ $ionicPopup.alert({ title: "Sélectionnez d'abord Votre Centre!", }); }
				else if(data.players){
					var parameters = { name: data.name, visibility: data.visibility, datetime: data.datetime,
						venue_id: data.venue_id, team_id: data.team_id, players: data.players,
						level: data.level, type: data.type,
					};
					if($scope.matchData.invities.length > 0){ parameters.invities = data.invities; }
					LoaderService.Show();
					var options = { fileKey: "image", fileName: $scope.fileName, chunkedMode: false, mimeType: "image/png", params: parameters, };
					$cordovaFileTransfer.upload(apiUrl + "/api/v1/match/create?api_token=" + $scope.apiToken, $scope.matchData.image, options).then(function(res){
						var matchData = JSON.parse(res.response);
						if(window.analytics){ $cordovaGoogleAnalytics.trackEvent('MatchCreation', 'Match Creation', "Name", data.name); };
						$cordovaSocialSharing.shareViaWhatsApp(matchData.shareWMessage, null, null).then(function(result){
							alert("Inviter ses contacts whatsapp au match Terminé");
							// $state.go("app.matchs", {}, { reload: true, });
							$scope.fbShare(matchData);
						}, function(err){
							$ionicPopup.alert({ title: error, });
							$state.go("app.matchs", {}, { reload: true, });
						});
					}, function(res){
						var status = res.http_status;
						if(status == 401){ $scope.deleteSession(); }
						else{
							var err = JSON.parse(res.body);
							if(err.validation){
								var error = "";
								angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
								$ionicPopup.alert({ title: error, });
							}else{
								var error = err.error;
								$ionicPopup.alert({ title: error, });
							}
							if(err.redirect){
								$backView = $ionicHistory.backView();
								if($backView){ $backView.go(); }
								else{ $scope.gotohome(); }
							}
							LoaderService.Hide();
						}
					}, function(progress){});
				}
			}else{ $scope.showContacts = num; };
		};
	};
	$scope.HideInvite = function(){
		LoaderService.Show();
		$scope.pageTitle = "Créer un match";
		$scope.pageView = 1;
		$ionicScrollDelegate.scrollTop();
		LoaderService.Hide();
	};
	$scope.ShowVenue = function(){
		$scope.pageTitle = "Choisir son centre";
		$scope.pageView = 3;
		$ionicScrollDelegate.scrollTop();
	};
	$scope.chooseText = "Choisissez Votre Centre";
	$scope.selectVenue = function(venue){
		if(venue){
			$scope.chooseText = venue.name;
			$scope.matchData.venue_id = venue.id;
			$scope.pageTitle = "Créer un match";
			$scope.pageView = 1;
			$ionicScrollDelegate.scrollTop();
		}
	};
	$scope.getData();
})

//=== Match Invite Controller ===//
.controller("MatchInvite", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.getData();
})

//=== Match List Controller ===//
.controller("Matchs", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService, $cordovaFacebook){
	/*$cordovaFacebook.getLoginStatus().then(function(success){
		alert(JSON.stringify(success));
	}, function (error){
		alert(JSON.stringify(error));
	});*/
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.matchs.forEach(function(x){
				x.datetime = new Date(x.datetime);
			});
			$scope.channels = res.channels;
			angular.forEach($scope.channels, function(channel, key){ PubNubService.subscribe({ channels: [channel], withPresence: true, }); });
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacths(apiUrl, $scope.apiToken).success($scope.success).error($scope.error);
	};
	$scope.goToCreateMatch = function(){
		$state.go("app.createMatch", {}, { reload: true, });
	};
	$scope.goToMatch = function(match){
		if(match){ $state.go("app.matchView", { matchId: match.id, }, { reload: true, }); }
	};
	$scope.getData();
})
//=== Post Match List Controller ===//
.controller("PostMatch", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa" {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.matchs.forEach(function(x){
				x.datetime = new Date(x.datetime);
			});
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getPostMacths(apiUrl, $scope.apiToken).success($scope.success).error($scope.error);
	};
	$scope.goToMatch = function(match){
		if(match){ $state.go("app.matchView", { matchId: match.id, }, { reload: true, }); }
	};
	$scope.getData();
})
//=== Rejoin Match List Controller ===//
.controller("Rejoin", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.matchs.forEach(function(x){
				x.datetimeS = moment(x.datetime, "YYYY-MM-DD HH:mm:ss").format("ddd D MMM - HH[H]mm");
				x.ratingsObject = {
					iconOn: 'ion-ios-star',
					iconOff: 'ion-ios-star-outline',
					iconOnColor: 'rgb(255, 215, 0)',
					iconOffColor:  'rgb(255, 215, 0)',
					rating: x.level,
					minRating: 1,
					readOnly: true,
					callback: function(rating, index){},
				}
			});
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getRejoinMacths(apiUrl, $scope.apiToken).success($scope.success).error($scope.error);
	};
	$scope.Participate = function(match){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, match.id).success(function(res){
			if(res.status){
				angular.forEach($scope.matchs, function(val, key){
					if(String(match.id) == String(val.id)){
						$scope.matchs.splice(key, 1);
					}
				});
			}else{ $ionicPopup.alert({ title: res.error, }); };
			LoaderService.Hide();
		}).error($scope.error);
	};
	$scope.goToMatch = function(match){
		if(match){
			$state.go("app.matchRejoin", { matchId: match.id, }, { reload: true, });
		}
	};
	$scope.getData();
})
//=== Match Rejoin Controller ===//
.controller("MatchRejoin", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){
				$scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true;
			}
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getJoinMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){ $state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, }); };
	$scope.swipeRight = function(){ $state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, }); };
	$scope.swipeLeft = function(){ $state.go("app.matchRejoinSlot", { matchId: $scope.match.id, }, { reload: true, }); };
	$scope.getData();
})
//=== Match Rejoin Slot Controller ===//
.controller("MatchRejoinSlot", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.joinAvailable = false;
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.team = res.team;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			$scope.joinAvailable = (!$scope.match.matchplayer) ? true : false;
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success(function(res){
			if(res.status){
				$state.go("app.matchView", { matchId: $scope.match.id, }, { reload: true, });
			}else{
				$ionicPopup.alert({ title: res.error, });
				LoaderService.Hide();
			};
		}).error($scope.error);
	};
	$scope.postMacthJoinSide = function(){
		LoaderService.Show();
		MatchService.postMacthJoinSide(apiUrl, $scope.apiToken, $scope.matchId).success(function(res){
			if(res.status){
				$state.go("app.matchView", { matchId: $scope.match.id, }, { reload: true, });
			}else{
				$ionicPopup.alert({ title: res.error, });
				LoaderService.Hide();
			};
		}).error($scope.error);
	};
	$scope.getNumber = function(count){
		var counts = [];
		if($scope.isSimpleDouble){
			if($scope.match.type == 'simple'){ for(var i = 1; i < count; i++){ counts.push(i); }; }
			else{ for(var i = 1; i < count - 1; i++){ counts.push(i); }; }
		}else{
			for(var i = 0; i < count; i++){ counts.push(i); };
		}
		console.log(counts)
		return counts;
	};
	$scope.posts = { attacker: "Attaquant", middle: "Milieu", defender: "Défenseur", guardian: "Gardien", };
	$scope.getMatchPlayers = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '0' || value.side == 0 && value.side == false){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.getMatchPlayersSide = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '1' || value.side == 1 && value.side == true){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getRejoinSlots(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){
		$state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.getData();
})
//=== Match View Controller ===//
.controller("MatchView", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){
		$state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.swipeRight = function(){
		/*if($scope.authuser.id == $scope.match.user_id){ $state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, }); }
		else{
			var isAccepted = false;
			angular.forEach($scope.match.matchplayers, function(val, key){
				if($scope.authuser.id == val.user_id && val.accept){ isAccepted = true; }
			});
			if(isAccepted){ $state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, }); }
		}*/
		$state.go("app.matchChat", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.swipeLeft = function(){
		/*if($scope.authuser.id != $scope.match.user_id){
			var isAccepted = false;
			angular.forEach($scope.match.matchplayers, function(val, key){ if($scope.authuser.id == val.user_id && val.accept){ isAccepted = true; } });
			if(isAccepted){ $state.go("app.matchSlot", { matchId: $scope.match.id, }, { reload: true, }); }
		}*/
		$state.go("app.matchSlot", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.shareSocial = function(){
		/*$cordovaSocialSharing.share("message", "subject", "file", "link").then(function(result){ // Share via native share sheet
			// Success!
		}, function(err){
			// An error occured. Show a message to the user
		});*/
	};
	$scope.getData();
})
//=== Match Slot Controller ===//
.controller("MatchSlot", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.isView = false;
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.joinAvailable = false;
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.team = res.team;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.ratingsObject = {
				iconOn: 'ion-ios-star',
				iconOff: 'ion-ios-star-outline',
				iconOnColor: 'rgb(255, 215, 0)',
				iconOffColor:  'rgb(255, 215, 0)',
				rating: 1,
				readOnly: true,
				minRating: 1,
				callback: function(level, index){}
			};
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			// $scope.joinAvailable = 
			var sportNames = ['tennis', 'squash', ];
			$scope.isSimpleDouble = (sportNames.indexOf($scope.currentUser.sport.name.toLowerCase()) >= 0);
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			$scope.isView = true;
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.postMacthJoin = function(){
		LoaderService.Show();
		MatchService.postMacthJoin(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.getNumber = function(count){
		var counts = [];
		if($scope.isSimpleDouble){
			if($scope.match.type == 'simple'){ for(var i = 1; i < count; i++){ counts.push(i); }; }
			else{ for(var i = 1; i < count - 1; i++){ counts.push(i); }; }
		}else{
			for(var i = 0; i < count; i++){ counts.push(i); };
		}
		console.log(counts)
		return counts;
	};
	$scope.posts = { attacker: "Attaquant", middle: "Milieu", defender: "Défenseur", guardian: "Gardien", };
	$scope.getMatchPlayers = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '0' || value.side == 0 && value.side == false){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.getMatchPlayersSide = function(index){
		var matchplayers = [], matchplayer = null;
		angular.forEach($scope.matchplayers, function(value, key){
			if(value.side == '1' || value.side == 1 && value.side == true){
				matchplayers.push(value);
			}
		});
		if(matchplayers.length >= index){
			matchplayer = matchplayers[index - 1];
		};
		return matchplayer;
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthSlots(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.goToMap = function(){
		$state.go("app.matchMap", { matchId: $scope.match.id, }, { reload: true, });
	};
	$scope.getData();
})
//=== Match Map Controller ===//
.controller("MatchMap", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.initialise = function(){
		var mapOptions = {
			center: new google.maps.LatLng($scope.match.venue.lat, $scope.match.venue.long),
			zoom: 5, mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map = new google.maps.Map(document.getElementById("map"), mapOptions);
		$scope.map = map;
		// Additional Markers //
		$scope.markers = [];
		var infoWindow = new google.maps.InfoWindow();
		var createMarker = function(info){
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(info.lat, info.long),
				map: $scope.map, animation: google.maps.Animation.DROP,
				title: info.city,
			});
			marker.content = '<div class="infoWindowContent">' + info.desc + '</div>';
			google.maps.event.addListener(marker, 'click', function(){
				infoWindow.setContent('<h2>' + marker.title + '</h2>' + marker.content);
				infoWindow.open($scope.map, marker);
			});
			$scope.markers.push(marker);
		}  
		createMarker({
			city: $scope.match.venue.location,
			desc: $scope.match.venue.name,
			lat: $scope.match.venue.lat,
			long: $scope.match.venue.long, 
		});
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.match.datetime = new Date(res.match.datetime);
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
			google.maps.event.addDomListener(document.getElementById("map"), 'load', $scope.initialise());
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getJoinMacthData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.getData();
})
//=== Event Chat Controller ===//
.controller("MatchChat", function($rootScope, $window, $state, $scope, $q, LoaderService, $filter, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $ionicScrollDelegate, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.matchId = $stateParams.matchId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.messages = res.messages;
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			PubNubService.subscribe({ channels: [$scope.match.channel], withPresence: true, });
			$scope.addListener();
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			$ionicScrollDelegate.scrollBottom();
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getMacthChatData(apiUrl, $scope.apiToken, $scope.matchId).success($scope.success).error($scope.error);
	};
	$scope.addListener = function(){
		PubNubService.addListener({
			status: function(statusEvent){
				if(statusEvent.category === "PNUnknownCategory"){
					var newState = { new: 'error', };
					PubNubService.setState({ state: newState, }, function(status){
						console.log(statusEvent.errorData.message)
					});
				}
			},
			message: function(res){
				if(res.message.user != $scope.authuser.id && res.message.isMatchChat){
					$scope.messages.push({
						match_id: res.message.match,
						user_id: res.message.user,
						message: res.message.message,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						created: moment().format("HH[h] mm[m]"),
					});
					if(!$scope.$$phase){ $scope.$apply(); }
					$ionicScrollDelegate.scrollBottom();
				}
			},
			presence: function(m){
				console.log(m)
			},
		});
	};
	$scope.message = "";
	$scope.sendMessage = function(form, message){
		if(form.$valid){
			var data = { message: message, user: $scope.authuser.id, match: $scope.match.id, userName: $scope.authuser.name, matchName: $scope.match.name, isMatchChat: true, };
			PubNubService.publish({
				message: data,
				channel: $scope.match.channel,
			}, function(status, response){
				if(status.error){ console.log(status); }
				else{
					$http.post(apiUrl + "/api/v1/match/message/" + $scope.match.id + "?api_token=" + $scope.apiToken, data, { headers: { 'Content-Type': "application/json", }, });
					$scope.messages.push({
						match_id: $scope.match.id,
						user_id: $scope.authuser.id,
						message: message,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						match: $scope.match,
						user: $scope.authuser,
						created: moment().format("HH[h] mm[m]"),
					});
					$scope.message = "";
				}
				if(!$scope.$$phase){ $scope.$apply(); }
				$ionicScrollDelegate.scrollBottom();
			});
		}
	};
	$scope.getData();
})
//=== Sport Match List Controller ===//
.controller("SportMatch", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.sportId = $stateParams.sportId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.matchs = res.matchs;
			$scope.sport = $scope.sport;
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.getData = function(){
		LoaderService.Show();
		MatchService.getSportMacths(apiUrl, $scope.apiToken, $scope.sportId).success($scope.success).error($scope.error);
	};
	$scope.goToMatch = function(match){
		if(match){
			$state.go("app.matchView", { matchId: match.id, }, { reload: true, });
		}
	};
	$scope.getData();
})
//=== Invite Friends Controller ===//
.controller("InviteFriend", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $ionicScrollDelegate, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, resource){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.search = "";
	$scope.isViewUser = 0;
	$scope.verticalHandleScroll = function(search){
		$ionicScrollDelegate.$getByHandle("verticalHandle").scrollBy(0, 0);
		if(search){
			$scope.search = search;
			$http.get(apiUrl + "/api/v1/friends/search-user?api_token=" + $scope.apiToken + "&page=1&search=" + search, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				$scope.users = [];
				for(var i = 0; i < res.users.length; i++){ $scope.users.push(res.users[i]); };
				$scope.currentPage = res.currentPage;
				if(res.lastPage > $scope.lastPage){ $scope.lastPage = res.lastPage; }
				$scope.isViewUser = 1;
			}).error($scope.error);
		}else{ $scope.isViewUser = 0; }
	};
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.getFriendUser = function(friend){
		if($scope.authuser.id == friend.friend_id){ return friend.user; }
		return friend.friend;
	};
	$scope.getMsgFriendUser = function(message){
		if($scope.authuser.id == message.sender.id){ return message.receiver; }
		return message.sender;
	};
	$scope.goToChat = function(friend){
		if(friend){ $state.go('app.chatFriend', { friendId: friend.id, }, { reload: true, }); };
	};
	$scope.addFriend = function(user){
		if(user){
			LoaderService.Show();
			$http.post(apiUrl + "/api/v1/friends/create/" + user.id + "?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				$rootScope.$broadcast("updateAuthUser", res.user);
				$state.go('app.chatFriend', { friendId: res.friend.id, }, { reload: true, });
			}).error($scope.error);
		};
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.friends = [];
	$scope.users = [];
	$scope.currentPage = 1;
	$scope.lastPage = 2;
	$scope.userLastPage = 2;
	$scope.userCurrentPage = 1;
	$scope.success = function(res){
		$scope.currentUser = $rootScope.currentUser = res.user;
		$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
		$window.localStorage.setItem('email', res.user.email);
		$window.localStorage.setItem('api_token', res.user.api_token);
		$window.localStorage.setItem('user', JSON.stringify(res.user));
		$window.sessionStorage.currentEmail = res.user.email; // Access Token details
		$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
		$window.sessionStorage.user_id = res.user.id;
		$scope.authuser = $scope.currentUser;
		$scope.messages = res.messages;
		for(var i = 0; i < res.friends.length; i++){ $scope.friends.push(res.friends[i]); };
		for(var i = 0; i < res.users.length; i++){ $scope.users.push(res.users[i]); };
		$scope.currentPage = res.currentPage;
		$scope.lastPage = res.lastPage;
		$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		if(!$scope.$$phase){ $scope.$apply(); }
		$scope.$broadcast('scroll.infiniteScrollComplete');
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		$scope.isLoading = false;
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			$scope.$broadcast('scroll.infiniteScrollComplete');
			LoaderService.Hide();
		};
	};
	$scope.getData = function(){
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	};
	$scope.loadMore =  function(){
		var page = ($scope.currentPage + 1);
		if(page <= $scope.lastPage){
			$http.get(apiUrl + "/api/v1/friends?api_token=" + $scope.apiToken + "&page=" + page, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
		}else{ $scope.$broadcast('scroll.infiniteScrollComplete'); }
	};
	$scope.loadMoreUser =  function(search){
		var page = ($scope.userCurrentPage + 1);
		if(page <= $scope.userLastPage && $scope.isLoading){
			$http.get(apiUrl + "/api/v1/friends/search-user?api_token=" + $scope.apiToken + "&page=" + page + "&search=" + $scope.search, { headers: { 'Content-Type': "application/json", }, }).success(function(res){
				for(var i = 0; i < res.users.length; i++){ $scope.users.push(res.users[i]); };
				$scope.userCurrentPage = res.currentPage;
				if(res.lastPage > $scope.userLastPage){ $scope.userLastPage = res.lastPage; }
				$scope.isViewUser = 1;
				$scope.isLoading = false;
			}).error($scope.error);
		}
	};
	$scope.isLoading = false;
	$scope.getScrollPosition = function(){
		if($scope.isViewUser == 1){
			$scope.isLoading = true;
			$scope.loadMoreUser($scope.search);
		};
	};
	$scope.getData();
})
//=== Friend Chat Controller ===//
.controller("FriendChat", function($rootScope, $window, $state, $scope, $q, LoaderService, $cordovaSocialSharing, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService, $ionicScrollDelegate, resource){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.friendId = $stateParams.friendId;
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		$scope.currentUser = $rootScope.currentUser = res.user;
		$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
		$window.localStorage.setItem('email', res.user.email);
		$window.localStorage.setItem('api_token', res.user.api_token);
		$window.localStorage.setItem('user', JSON.stringify(res.user));
		$window.sessionStorage.currentEmail = res.user.email; // Access Token details
		$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
		$window.sessionStorage.user_id = res.user.id;
		$scope.authuser = $scope.currentUser;
		$scope.friend = res.friend;
		$scope.messages = res.messages;
		PubNubService.subscribe({ channels: [$scope.friend.channel], withPresence: true, });
		$scope.addListener();
		$scope.friendUser = ($scope.authuser.id == $scope.friend.friend_id) ? $scope.friend.user : $scope.friend.friend;
		$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
		if(!$scope.$$phase){ $scope.$apply(); }
		LoaderService.Hide();
		$timeout(function(){
			$ionicScrollDelegate.scrollBottom();
		}, 100);
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		};
	};
	$scope.addListener = function(){
		PubNubService.addListener({
			status: function(statusEvent){
				if(statusEvent.category === "PNUnknownCategory"){
					var newState = { new: 'error', };
					PubNubService.setState({ state: newState, }, function(status){
						console.log(statusEvent.errorData.message)
					});
				}
			},
			message: function(res){
				if(res.message.senderId != $scope.authuser.id && res.message.isFriendChat){
					$scope.messages.push({
						friend_id: res.message.friend,
						sender_id: res.message.senderId,
						receiver_id: res.message.receiverId,
						message: res.message.message,
						sender: $scope.friendUser,
						receiver: $scope.authuser,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
					});
					if(!$scope.$$phase){ $scope.$apply(); }
					$ionicScrollDelegate.scrollBottom();
				}
			},
			presence: function(m){
				console.log(m)
			},
		});
	};
	$scope.message = "";
	$scope.sendMessage = function(form, message){
		if(form.$valid){
			var data = { message: message, friend: $scope.friend.id, senderId: $scope.authuser.id, senderName: $scope.authuser.name, receiverId: $scope.friendUser.id, receiverName: $scope.friendUser.name, isFriendChat: true, };
			PubNubService.publish({
				message: data,
				channel: $scope.friend.channel,
			}, function(status, response){
				if(status.error){ console.log(status); }
				else{
					$http.post(apiUrl + "/api/v1/friends/chat/" + $scope.friend.id + "?api_token=" + $scope.apiToken, data, { headers: { 'Content-Type': "application/json", }, });
					$scope.messages.push({
						friend_id: $scope.friend.id,
						sender_id: $scope.authuser.id,
						sender: $scope.authuser,
						receiver_id: $scope.friendUser.id,
						receiver: $scope.friendUser,
						message: message,
						created_at: moment().format("YYYY-MM-DD HH:mm:ss"),
						updated_at: moment().format("YYYY-MM-DD HH:mm:ss"),
					});
					$scope.message = "";
				}
				if(!$scope.$$phase){ $scope.$apply(); }
				$ionicScrollDelegate.scrollBottom();
			});
		}
	};
	$scope.getData = function(){
		if(resource.status >= 400){ $scope.error(resource.data, resource.status); }
		else{ $scope.success(resource.data, resource.status); }
	};
	$scope.getData();
})
//=== Chat Controller ===//
.controller("Chat", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService, PubNubService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.match = res.match;
			$scope.days = Math.round(moment.duration(moment(new Date()).diff(moment($scope.match.datetime, "YYYY-MM-DD HH:mm:ss"))).asDays());
			$scope.matchplayers = res.matchplayers;
			if($scope.match.matchplayer){ $scope.match.matchplayer.accept = ($scope.match.matchplayer.accept == '0') ? false : true; }
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.messages = [];
	PubNubService.history({
		channel: 'ch1',
	}, function(status, messages){
		if(status.error){ console.log("operation failed w/ status: ", status); }
		else{
			console.log(messages);
			/*angular.forEach(messages.channels['ch1'], function(val, key){
				$scope.messages.push(val);
			});*/
		}
	});
	PubNubService.addListener({
		status: function(statusEvent){
			if(statusEvent.category === "PNUnknownCategory"){
				var newState = { new: 'error', };
				PubNubService.setState({ state: newState, }, function(status){
					console.log(statusEvent.errorData.message)
				});
			}
		},
		message: function(res){
			console.log(res.message);
		},
		/*presence: function(m){
			console.log(m)
		},*/
	});
	// PubNubService.subscribe({ channels: ['ch1'], withPresence: true, });
	$scope.message = "";
	$scope.sendMessage = function(form, message){
		if(form.$valid){
			PubNubService.publish({
				message: {
					message: message,
					// user: user,
				},
				channel: 'ch1'
			}, function(status, response){
				if(status.error){
					console.log(status)
				}else{
					$scope.message = "";
				}
				if(!$scope.$$phase){ $scope.$apply(); }
			});
		}
	};

	LoaderService.Hide();
})
//=== Reglages Controller ===//
.controller("Reglages", function($rootScope, $window, $state, $scope, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $stateParams, $timeout, ionicDatePicker, ionicTimePicker, apiUrl, MatchService){
	$scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");
	if(!$scope.email || !$scope.apiToken){ $state.go("myloginpa", {}, { reload: true, }); };
	$scope.authuser = JSON.parse($window.localStorage.getItem('user'));
	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };
	$scope.deleteSession = function(){
		$rootScope.currentUser = {};
		$scope.loginData = {};
		$scope.loginData.email = $window.localStorage.getItem('login_email');
		$scope.loginData.password = $window.localStorage.getItem('login_password');
		delete $window.sessionStorage.currentEmail;
		delete $window.sessionStorage.currentApi_token;
		delete $window.sessionStorage.user_id;
		$window.localStorage.clear();
		$ionicHistory.clearCache();
		$ionicHistory.clearHistory();
		$window.localStorage.setItem('login_email', $scope.loginData.email);
		$window.localStorage.setItem('login_password', $scope.loginData.password);
		for(var prop in $rootScope){ if(prop.substring(0,1) !== '$'){ delete $rootScope[prop]; } }
		LoaderService.Hide();
		$state.go("myloginpa", {}, { reload: true, });
	};
	$scope.ImageUrl = function(url){ return apiUrl + '/' + url; };
	$scope.success = function(res){
		if(res.status){
			$scope.currentUser = $rootScope.currentUser = res.user;
			$scope.currentUser.birthdate = moment($scope.currentUser.birthdate).format("DD/MM/YYYY");
			$window.localStorage.setItem('email', res.user.email);
			$window.localStorage.setItem('api_token', res.user.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.user));
			$window.sessionStorage.currentEmail = res.user.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.user.api_token; // Access Token details
			$window.sessionStorage.user_id = res.user.id;
			$scope.authuser = $scope.currentUser;
			$scope.usersports = res.usersports;
			/*angular.forEach($scope.usersports, function(val, key){
				val.status = (val.status || val.status == 1) ? true : false;
			});*/
			$rootScope.$broadcast("updateAuthUser", $scope.currentUser);
			if(!$scope.$$phase){ $scope.$apply(); }
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};
	$scope.error = function(err, status){
		if(status == 401){ $scope.deleteSession(); }
		else{
			var error = err.error;
			if(err.validation){
				error = "";
				angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
			}
			$ionicPopup.alert({ title: error, });
			if(err.redirect){
				$backView = $ionicHistory.backView();
				if($backView){ $backView.go(); }
				else{ $scope.gotohome(); }
			}
			LoaderService.Hide();
		}
	};
	$scope.toggleChange = function(usersport){
		$http.post(apiUrl + "/api/v1/sport/update/" + usersport.id + "?api_token=" + $scope.apiToken, usersport, { headers: { 'Content-Type': "application/json", }, }).error($scope.error);
	};
	$scope.getData = function(){
		LoaderService.Show();
		$http.get(apiUrl + "/api/v1/sport?api_token=" + $scope.apiToken, { headers: { 'Content-Type': "application/json", }, }).success($scope.success).error($scope.error);
	};
	$scope.getData();
})



/*.controller('MyLog', function( $scope){
	console.log("test");
*/


.controller('bhuvana', function($rootScope, $window, $state, $scope, $cordovaGoogleAnalytics, $q, LoaderService, $ionicModal, $timeout, $stateParams, $http, $ionicPopup, $ionicHistory, $timeout, $cordovaOauth, apiUrl, facebookApi, googleApi, $cordovaDevice)
{
       
    $scope.$state = $state;
	$scope.email = $window.localStorage.getItem("email");
	$scope.apiToken = $window.localStorage.getItem("api_token");

	$scope.gotohome = function(){ $state.go("app.home", {}, { reload: true, }); };

	if($scope.email && $scope.apiToken)

		{
		 $scope.gotohome();
		  };

	var strEmail = $window.localStorage.getItem('login_email');

	$scope.loginData = (strEmail != null && strEmail != 'null') ? { email: strEmail, password: $window.localStorage.getItem('login_password'), } : {};

	if(window.cordova){
	 $scope.deviceId = $cordovaDevice.getUUID(); 
	}

	else{
	 $scope.deviceId = moment().format("YYYYMMDDTHHmmssS");
	  }

	if(window.analytics){
	 $cordovaGoogleAnalytics.trackView('Login'); 
	};

	$scope.success = function(res){
		if(res.status){

			res.data.api_token = res.api_token;
			$rootScope.currentUser = res.data;
			$window.localStorage.setItem('login_email', $scope.loginData.email);
			$window.localStorage.setItem('login_password', $scope.loginData.password);
			$window.localStorage.setItem('email', res.data.email);
			$window.localStorage.setItem('api_token', res.api_token);
			$window.localStorage.setItem('user', JSON.stringify(res.data));
			$window.sessionStorage.currentEmail = res.data.email; // Access Token details
			$window.sessionStorage.currentApi_token = res.api_token; // Access Token details
			$window.sessionStorage.user_id = res.data.id;

			if(window.analytics){
			 $cordovaGoogleAnalytics.trackEvent('Login', 'User Login', "Email", $rootScope.currentUser.email); };


			$state.go("app.home", {}, { reload: true, });
		}else{ $ionicPopup.alert({ title: res.error, }); };
		LoaderService.Hide();
	};


	$scope.error = function(err){

		var error = err.error;
		if(err.validation){
			error = "";
			angular.forEach(err.errors, function(value, key){ error += value + "<br>"; });
		}
		$ionicPopup.alert({ title: error, });
		LoaderService.Hide();};


	$scope.Login = function(form, data){

		if(form.$valid){
			$scope.loginData.email = data.email;
			$scope.loginData.password = data.password;
			try{
				LoaderService.Show();
				$http.defaults.headers.post["Content-Type"] = "application/json";

				$http.post(apiUrl + "/api/v1/auth/login", {
					email: $scope.loginData.email,
					password: $scope.loginData.password,
					deviceId: $scope.deviceId,
				}).success($scope.success).error($scope.error);
			}

			catch(err){
				$ionicPopup.alert({ title: err.error, template: err, });
				LoaderService.Hide();
			}
		};
	};


});